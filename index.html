<!doctype html>
<html lang="id" class="h-full">
 <head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Kassify - Kas Kelas Digital</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="/_sdk/element_sdk.js"></script>
  <script src="/_sdk/data_sdk.js"></script>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700;800&amp;display=swap" rel="stylesheet">
  <style>
    body {
      box-sizing: border-box;
    }
    * {
      font-family: 'Plus Jakarta Sans', sans-serif;
    }
    
    /* Dark Mode Variables */
    :root {
      --bg-primary: #ffffff;
      --bg-secondary: #f8fafc;
      --bg-tertiary: #f1f5f9;
      --text-primary: #1e293b;
      --text-secondary: #64748b;
      --border-color: #e2e8f0;
      --hover-bg: #f1f5f9;
    }
    
    .dark-mode {
      --bg-primary: #0f172a;
      --bg-secondary: #1e293b;
      --bg-tertiary: #334155;
      --text-primary: #f1f5f9;
      --text-secondary: #cbd5e1;
      --border-color: #334155;
      --hover-bg: #1e293b;
    }
    
    .glass {
      background: rgba(255, 255, 255, 0.95);
      backdrop-filter: blur(20px);
    }
    
    .dark-mode .glass {
      background: rgba(15, 23, 42, 0.95);
    }
    
    .gradient-primary {
      background: linear-gradient(135deg, #0ea5e9 0%, #0284c7 50%, #0369a1 100%);
    }
    .gradient-success {
      background: linear-gradient(135deg, #10b981 0%, #059669 100%);
    }
    .gradient-danger {
      background: linear-gradient(135deg, #f43f5e 0%, #e11d48 100%);
    }
    .gradient-warning {
      background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
    }
    .gradient-purple {
      background: linear-gradient(135deg, #8b5cf6 0%, #7c3aed 100%);
    }
    
    .card-hover {
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    }
    .card-hover:hover {
      transform: translateY(-4px);
      box-shadow: 0 20px 40px -12px rgba(0, 0, 0, 0.15);
    }
    
    .animate-fade-in {
      animation: fadeIn 0.5s cubic-bezier(0.4, 0, 0.2, 1);
    }
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(20px); }
      to { opacity: 1; transform: translateY(0); }
    }
    
    .animate-slide-in {
      animation: slideIn 0.5s cubic-bezier(0.4, 0, 0.2, 1);
    }
    @keyframes slideIn {
      from { opacity: 0; transform: translateX(-30px); }
      to { opacity: 1; transform: translateX(0); }
    }
    
    .toast {
      animation: toastIn 0.4s cubic-bezier(0.34, 1.56, 0.64, 1);
    }
    @keyframes toastIn {
      from { opacity: 0; transform: translateY(-30px) scale(0.9); }
      to { opacity: 1; transform: translateY(0) scale(1); }
    }
    
    .modal-overlay {
      animation: overlayIn 0.3s ease-out;
    }
    @keyframes overlayIn {
      from { opacity: 0; }
      to { opacity: 1; }
    }
    
    #modal-container {
      background: rgba(0, 0, 0, 0.5);
    }
    
    .modal-content {
      animation: modalIn 0.4s cubic-bezier(0.34, 1.56, 0.64, 1);
    }
    @keyframes modalIn {
      from { opacity: 0; transform: scale(0.9) translateY(-20px); }
      to { opacity: 1; transform: scale(1) translateY(0); }
    }
    
    .animate-bounce-in {
      animation: bounceIn 0.5s cubic-bezier(0.68, -0.55, 0.265, 1.55);
    }
    @keyframes bounceIn {
      0% { opacity: 0; transform: scale(0.3); }
      50% { opacity: 1; transform: scale(1.05); }
      70% { transform: scale(0.9); }
      100% { transform: scale(1); }
    }
    
    .animate-slide-up {
      animation: slideUp 0.4s cubic-bezier(0.4, 0, 0.2, 1);
    }
    @keyframes slideUp {
      from { opacity: 0; transform: translateY(30px); }
      to { opacity: 1; transform: translateY(0); }
    }
    
    .animate-scale-in {
      animation: scaleIn 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);
    }
    @keyframes scaleIn {
      from { opacity: 0; transform: scale(0.8); }
      to { opacity: 1; transform: scale(1); }
    }
    
    .spinner {
      border: 3px solid rgba(255, 255, 255, 0.3);
      border-radius: 50%;
      border-top: 3px solid white;
      width: 24px;
      height: 24px;
      animation: spin 0.8s linear infinite;
    }
    
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
    
    .scrollbar-thin::-webkit-scrollbar {
      width: 6px;
    }
    .scrollbar-thin::-webkit-scrollbar-track {
      background: var(--bg-tertiary);
      border-radius: 3px;
    }
    .scrollbar-thin::-webkit-scrollbar-thumb {
      background: var(--border-color);
      border-radius: 3px;
    }
    .scrollbar-thin::-webkit-scrollbar-thumb:hover {
      background: var(--text-secondary);
    }
    
    .tooltip {
      position: relative;
    }
    
    .tooltip::after {
      content: attr(data-tooltip);
      position: absolute;
      bottom: 100%;
      left: 50%;
      transform: translateX(-50%);
      padding: 6px 12px;
      background: rgba(0, 0, 0, 0.9);
      color: white;
      font-size: 12px;
      border-radius: 6px;
      white-space: nowrap;
      opacity: 0;
      pointer-events: none;
      transition: opacity 0.2s;
      margin-bottom: 5px;
    }
    
    .tooltip:hover::after {
      opacity: 1;
    }
    
    @media (max-width: 768px) {
      .modal-content {
        max-height: 100%;
        border-radius: 0;
      }
    }
  </style>
  <style>@view-transition { navigation: auto; }</style>
 </head>
 <body class="h-full overflow-auto" style="background: var(--bg-secondary); color: var(--text-primary);"><!-- Toast Container -->
  <div id="toast-container" class="fixed top-4 right-4 z-50 flex flex-col gap-2"></div><!-- Loading Overlay -->
  <div id="loading-overlay" class="hidden fixed inset-0 bg-black/50 z-50 flex items-center justify-center">
   <div class="bg-white dark:bg-slate-800 rounded-2xl p-8 flex flex-col items-center gap-4">
    <div class="spinner"></div>
    <p class="text-slate-600 dark:text-slate-300">Memuat...</p>
   </div>
  </div><!-- ==================== LOGIN PAGE ==================== -->
  <div id="page-login" class="page min-h-full flex items-center justify-center p-4" style="background: linear-gradient(135deg, #0ea5e9 0%, #0284c7 50%, #0369a1 100%);">
   <div class="w-full max-w-md">
    <div class="text-center mb-8 animate-fade-in">
     <div class="w-20 h-20 gradient-primary rounded-3xl flex items-center justify-center mx-auto mb-4 shadow-2xl shadow-sky-900/50">
      <svg class="w-12 h-12 text-white" fill="none" stroke="currentColor" viewbox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
      </svg>
     </div>
     <h1 id="login-app-title" class="text-4xl font-bold text-white mb-2">Kassify</h1>
     <p class="text-sky-100">Sistem Manajemen Kas Kelas Digital</p>
    </div>
    <div class="glass rounded-3xl shadow-2xl p-8 animate-slide-in"><!-- Login Form -->
     <div id="login-form-container">
      <h2 class="text-2xl font-bold mb-6" style="color: var(--text-primary);">Masuk ke Akun</h2>
      <form id="login-form" onsubmit="handleLogin(event)">
       <div class="space-y-4">
        <div><label for="login-username" class="block text-sm font-medium mb-2" style="color: var(--text-secondary);">Username atau Email</label> <input type="text" id="login-username" required placeholder="username atau email@example.com" class="w-full px-4 py-3 rounded-xl border focus:ring-2 focus:ring-sky-500 focus:border-sky-500 transition-all" style="background: var(--bg-primary); border-color: var(--border-color); color: var(--text-primary);">
        </div>
        <div><label for="login-password" class="block text-sm font-medium mb-2" style="color: var(--text-secondary);">Password</label> <input type="password" id="login-password" required placeholder="â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢" class="w-full px-4 py-3 rounded-xl border focus:ring-2 focus:ring-sky-500 focus:border-sky-500 transition-all" style="background: var(--bg-primary); border-color: var(--border-color); color: var(--text-primary);">
        </div>
       </div><button type="submit" id="login-submit-btn" class="w-full gradient-primary text-white py-3 rounded-xl font-semibold mt-6 hover:shadow-lg transition-all"> Masuk </button>
      </form>
      <div class="mt-6 text-center">
       <p style="color: var(--text-secondary);">Belum punya akun? <button onclick="showRegisterForm()" class="text-sky-500 font-semibold hover:text-sky-600">Daftar Sekarang</button></p>
      </div>
     </div><!-- Register Form -->
     <div id="register-form-container" class="hidden">
      <h2 class="text-2xl font-bold mb-6" style="color: var(--text-primary);">Buat Akun Baru</h2>
      <form id="register-form" onsubmit="handleRegister(event)">
       <div class="space-y-4">
        <div><label for="register-fullname" class="block text-sm font-medium mb-2" style="color: var(--text-secondary);">Nama Lengkap</label> <input type="text" id="register-fullname" required placeholder="Nama lengkap Anda" class="w-full px-4 py-3 rounded-xl border focus:ring-2 focus:ring-sky-500 focus:border-sky-500 transition-all" style="background: var(--bg-primary); border-color: var(--border-color); color: var(--text-primary);">
        </div>
        <div><label for="register-username" class="block text-sm font-medium mb-2" style="color: var(--text-secondary);">Username</label> <input type="text" id="register-username" required placeholder="username" class="w-full px-4 py-3 rounded-xl border focus:ring-2 focus:ring-sky-500 focus:border-sky-500 transition-all" style="background: var(--bg-primary); border-color: var(--border-color); color: var(--text-primary);">
        </div>
        <div><label for="register-email" class="block text-sm font-medium mb-2" style="color: var(--text-secondary);">Email</label> <input type="email" id="register-email" required placeholder="email@example.com" class="w-full px-4 py-3 rounded-xl border focus:ring-2 focus:ring-sky-500 focus:border-sky-500 transition-all" style="background: var(--bg-primary); border-color: var(--border-color); color: var(--text-primary);">
        </div>
        <div><label for="register-password" class="block text-sm font-medium mb-2" style="color: var(--text-secondary);">Password</label> <input type="password" id="register-password" required placeholder="â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢" minlength="6" class="w-full px-4 py-3 rounded-xl border focus:ring-2 focus:ring-sky-500 focus:border-sky-500 transition-all" style="background: var(--bg-primary); border-color: var(--border-color); color: var(--text-primary);">
        </div>
       </div><button type="submit" id="register-submit-btn" class="w-full gradient-primary text-white py-3 rounded-xl font-semibold mt-6 hover:shadow-lg transition-all"> Daftar </button>
      </form>
      <div class="mt-6 text-center">
       <p style="color: var(--text-secondary);">Sudah punya akun? <button onclick="showLoginForm()" class="text-sky-500 font-semibold hover:text-sky-600">Masuk</button></p>
      </div>
     </div>
    </div>
   </div>
  </div><!-- ==================== HOME PAGE ==================== -->
  <div id="page-home" class="page hidden min-h-full"><!-- Navbar -->
   <nav class="sticky top-0 z-40 border-b shadow-sm" style="background: var(--bg-primary); border-color: var(--border-color);">
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
     <div class="flex items-center justify-between h-16">
      <div class="flex items-center gap-3">
       <div class="w-10 h-10 gradient-primary rounded-xl flex items-center justify-center shadow-lg shadow-sky-200">
        <svg class="w-6 h-6 text-white" fill="none" stroke="currentColor" viewbox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
        </svg>
       </div>
       <h1 id="home-app-title" class="text-xl font-bold">Kassify</h1>
      </div>
      <div class="flex items-center gap-3"><!-- Dark Mode Toggle --> <button onclick="toggleDarkMode()" class="tooltip p-2 rounded-xl hover:bg-opacity-10 transition-all" data-tooltip="Mode Gelap" style="background: var(--hover-bg);">
        <svg id="dark-mode-icon" class="w-6 h-6" fill="none" stroke="currentColor" viewbox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20.354 15.354A9 9 0 018.646 3.646 9.003 9.003 0 0012 21a9.003 9.003 0 008.354-5.646z" />
        </svg></button> <!-- Notifications --> <button onclick="toggleNotificationPanel()" class="tooltip relative p-2 rounded-xl hover:bg-opacity-10 transition-all" data-tooltip="Notifikasi" style="background: var(--hover-bg);">
        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewbox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 17h5l-1.405-1.405A2.032 2.032 0 0118 14.158V11a6.002 6.002 0 00-4-5.659V5a2 2 0 10-4 0v.341C7.67 6.165 6 8.388 6 11v3.159c0 .538-.214 1.055-.595 1.436L4 17h5m6 0v1a3 3 0 11-6 0v-1m6 0H9" />
        </svg><span id="home-notif-badge" class="hidden absolute -top-1 -right-1 bg-rose-500 text-white text-xs px-1.5 py-0.5 rounded-full min-w-[20px] text-center">0</span> </button> <!-- Profile --> <button onclick="toggleProfileMenu()" class="flex items-center gap-2 p-2 rounded-xl hover:bg-opacity-10 transition-all" style="background: var(--hover-bg);">
        <div id="nav-avatar" class="w-8 h-8 bg-gradient-to-br from-sky-400 to-sky-600 rounded-full flex items-center justify-center text-white font-bold text-sm">
         U
        </div><span id="nav-username" class="font-medium hidden sm:inline">User</span>
        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewbox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" />
        </svg></button>
      </div>
     </div>
    </div>
   </nav><!-- Profile Dropdown -->
   <div id="profile-menu" class="hidden fixed top-16 right-4 w-64 rounded-2xl shadow-2xl border z-50 animate-fade-in" style="background: var(--bg-primary); border-color: var(--border-color);">
    <div class="p-4"><button onclick="openProfileModal()" class="w-full flex items-center gap-3 p-3 rounded-xl hover:bg-opacity-10 transition-all text-left" style="background: var(--hover-bg);">
      <svg class="w-5 h-5" fill="none" stroke="currentColor" viewbox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z" />
      </svg><span class="font-medium">Edit Profil</span> </button> <button onclick="handleLogout()" class="w-full flex items-center gap-3 p-3 rounded-xl hover:bg-rose-50 text-rose-600 transition-all text-left mt-2">
      <svg class="w-5 h-5" fill="none" stroke="currentColor" viewbox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1" />
      </svg><span class="font-medium">Keluar</span> </button>
    </div>
   </div><!-- Notification Panel -->
   <div id="notification-panel" class="hidden fixed top-16 right-4 w-96 max-w-[calc(100vw-2rem)] max-h-[80vh] rounded-2xl shadow-2xl border z-50 flex flex-col" style="background: var(--bg-primary); border-color: var(--border-color);">
    <div class="p-4 border-b" style="border-color: var(--border-color);">
     <div class="flex items-center justify-between mb-3">
      <h3 class="font-bold text-lg">Notifikasi</h3><button onclick="toggleNotificationPanel()" class="p-1 rounded-lg hover:bg-opacity-10" style="background: var(--hover-bg);">
       <svg class="w-5 h-5" fill="none" stroke="currentColor" viewbox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
       </svg></button>
     </div>
     <div class="flex gap-2"><button onclick="filterNotifications('unread')" class="notif-filter-btn flex-1 px-3 py-2 rounded-lg text-sm font-medium transition-all bg-sky-500 text-white" data-filter="unread"> Belum Dibaca </button> <button onclick="filterNotifications('read')" class="notif-filter-btn flex-1 px-3 py-2 rounded-lg text-sm font-medium transition-all" data-filter="read" style="background: var(--hover-bg);"> Sudah Dibaca </button>
     </div>
    </div>
    <div id="notification-list" class="flex-1 overflow-auto scrollbar-thin p-2">
     <div class="p-8 text-center" style="color: var(--text-secondary);">
      <svg class="w-12 h-12 mx-auto mb-3 opacity-50" fill="none" stroke="currentColor" viewbox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 17h5l-1.405-1.405A2.032 2.032 0 0118 14.158V11a6.002 6.002 0 00-4-5.659V5a2 2 0 10-4 0v.341C7.67 6.165 6 8.388 6 11v3.159c0 .538-.214 1.055-.595 1.436L4 17h5m6 0v1a3 3 0 11-6 0v-1m6 0H9" />
      </svg>
      <p>Belum ada notifikasi</p>
     </div>
    </div>
   </div><!-- Main Content -->
   <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8"><!-- Welcome Section -->
    <div class="mb-8 animate-fade-in">
     <div class="flex flex-col sm:flex-row items-start sm:items-center justify-between gap-4">
      <div>
       <h2 class="text-3xl font-bold mb-2"><span id="welcome-text">Selamat Datang</span>, <span id="welcome-username" class="text-sky-500">User</span>! ðŸ‘‹</h2>
       <p style="color: var(--text-secondary);" id="current-date-time">Loading...</p>
      </div>
     </div>
    </div><!-- Quick Stats -->
    <div class="grid grid-cols-1 sm:grid-cols-3 gap-6 mb-8"><!-- Classes Card --> <button onclick="scrollToClasses()" class="card-hover rounded-2xl p-6 shadow-sm border text-left group" style="background: var(--bg-primary); border-color: var(--border-color);">
      <div class="flex items-center justify-between mb-4">
       <div class="w-12 h-12 gradient-primary rounded-xl flex items-center justify-center shadow-lg shadow-sky-200 group-hover:scale-110 transition-transform">
        <svg class="w-6 h-6 text-white" fill="none" stroke="currentColor" viewbox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 011-1h2a1 1 0 011 1v5m-4 0h4" />
        </svg>
       </div>
      </div><p class="text-3xl font-bold mb-1" id="total-classes">0</p><p style="color: var(--text-secondary);">Kelas</p></button> <!-- Tasks Card --> <button onclick="openTasksPopup()" class="card-hover rounded-2xl p-6 shadow-sm border text-left group" style="background: var(--bg-primary); border-color: var(--border-color);">
      <div class="flex items-center justify-between mb-4">
       <div class="w-12 h-12 gradient-warning rounded-xl flex items-center justify-center shadow-lg shadow-amber-200 group-hover:scale-110 transition-transform">
        <svg class="w-6 h-6 text-white" fill="none" stroke="currentColor" viewbox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-6 9l2 2 4-4" />
        </svg>
       </div>
      </div><p class="text-3xl font-bold mb-1" id="total-tasks">0</p><p style="color: var(--text-secondary);">Tugas</p></button> <!-- Messages Card --> <button onclick="openMessagesPopup()" class="card-hover rounded-2xl p-6 shadow-sm border text-left group" style="background: var(--bg-primary); border-color: var(--border-color);">
      <div class="flex items-center justify-between mb-4">
       <div class="w-12 h-12 gradient-success rounded-xl flex items-center justify-center shadow-lg shadow-emerald-200 group-hover:scale-110 transition-transform">
        <svg class="w-6 h-6 text-white" fill="none" stroke="currentColor" viewbox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z" />
        </svg>
       </div>
      </div><p class="text-3xl font-bold mb-1" id="total-messages">0</p><p style="color: var(--text-secondary);">Pesan</p></button>
    </div><!-- Classes Section -->
    <div id="classes-section">
     <div class="flex items-center justify-between mb-6">
      <div>
       <h3 class="text-2xl font-bold">Kelas Saya</h3>
       <p style="color: var(--text-secondary);">Daftar kelas yang Anda ikuti</p>
      </div><button onclick="openCreateClassModal()" class="gradient-primary text-white px-4 py-2.5 rounded-xl font-medium shadow-lg shadow-sky-200 hover:shadow-sky-300 transition-all flex items-center gap-2">
       <svg class="w-5 h-5" fill="none" stroke="currentColor" viewbox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6" />
       </svg> Buat Kelas </button>
     </div>
     <div id="classes-grid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
      <div class="col-span-full p-8 text-center rounded-2xl border" style="color: var(--text-secondary); background: var(--bg-primary); border-color: var(--border-color);">
       <svg class="w-12 h-12 mx-auto mb-3 opacity-50" fill="none" stroke="currentColor" viewbox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 011-1h2a1 1 0 011 1v5m-4 0h4" />
       </svg>
       <p>Belum ada kelas. Buat kelas baru atau tunggu undangan!</p>
      </div>
     </div>
    </div>
   </div>
  </div><!-- ==================== CLASS PAGE ==================== -->
  <div id="page-class" class="page hidden min-h-full flex flex-col"><!-- Class Navbar -->
   <nav class="sticky top-0 z-40 border-b shadow-sm" style="background: var(--bg-primary); border-color: var(--border-color);">
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
     <div class="flex items-center justify-between h-16">
      <div class="flex items-center gap-3"><button onclick="backToHome()" class="tooltip p-2 rounded-xl hover:bg-opacity-10 transition-all" data-tooltip="Kembali ke Beranda" style="background: var(--hover-bg);">
        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewbox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18" />
        </svg></button>
       <div>
        <h1 id="class-title" class="text-lg sm:text-xl font-bold">Nama Kelas</h1>
        <p id="class-role-badge" class="text-xs" style="color: var(--text-secondary);">Role</p>
       </div>
      </div>
      <div class="flex items-center gap-2"><button onclick="openClassSettingsModal()" class="tooltip p-2 rounded-xl hover:bg-opacity-10 transition-all" data-tooltip="Pengaturan Kelas" style="background: var(--hover-bg);">
        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewbox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z" /> <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" />
        </svg></button>
      </div>
     </div>
    </div>
   </nav><!-- Class Tabs -->
   <div class="border-b" style="background: var(--bg-primary); border-color: var(--border-color);">
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
     <div class="flex gap-1 overflow-x-auto scrollbar-thin"><button onclick="switchClassTab('info')" class="class-tab-btn px-4 py-3 font-medium border-b-2 border-sky-500 text-sky-500 whitespace-nowrap" data-tab="info"> Pusat Informasi </button> <button onclick="switchClassTab('finance')" class="class-tab-btn px-4 py-3 font-medium border-b-2 border-transparent whitespace-nowrap hover:bg-opacity-10" data-tab="finance" style="color: var(--text-secondary); background: var(--hover-bg);"> Keuangan </button> <button onclick="switchClassTab('members')" class="class-tab-btn px-4 py-3 font-medium border-b-2 border-transparent whitespace-nowrap hover:bg-opacity-10" data-tab="members" style="color: var(--text-secondary); background: var(--hover-bg);"> Anggota </button> <button onclick="switchClassTab('chat')" class="class-tab-btn px-4 py-3 font-medium border-b-2 border-transparent whitespace-nowrap hover:bg-opacity-10" data-tab="chat" style="color: var(--text-secondary); background: var(--hover-bg);"> Chat </button> <button id="billing-tab-btn" onclick="switchClassTab('billing')" class="class-tab-btn hidden px-4 py-3 font-medium border-b-2 border-transparent whitespace-nowrap hover:bg-opacity-10" data-tab="billing" style="color: var(--text-secondary); background: var(--hover-bg);"> Tagihan </button>
     </div>
    </div>
   </div><!-- Class Content -->
   <div class="flex-1 overflow-auto" style="background: var(--bg-secondary);">
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8"><!-- Info Tab -->
     <div id="class-tab-info" class="class-tab-content">
      <div class="flex items-center justify-between mb-6">
       <div>
        <h3 class="text-2xl font-bold">Pusat Informasi</h3>
        <p style="color: var(--text-secondary);">Informasi tugas dan pengumuman kelas</p>
       </div><button id="add-task-btn" onclick="openAddTaskModal()" class="hidden gradient-primary text-white px-4 py-2.5 rounded-xl font-medium shadow-lg hover:shadow-xl transition-all flex items-center gap-2">
        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewbox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6" />
        </svg> Tambah Tugas </button>
      </div>
      <div id="tasks-list" class="space-y-4">
       <div class="rounded-2xl border p-8 text-center" style="color: var(--text-secondary); background: var(--bg-primary); border-color: var(--border-color);">
        <svg class="w-12 h-12 mx-auto mb-3 opacity-50" fill="none" stroke="currentColor" viewbox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-6 9l2 2 4-4" />
        </svg>
        <p>Belum ada tugas atau pengumuman</p>
       </div>
      </div>
     </div><!-- Finance Tab -->
     <div id="class-tab-finance" class="class-tab-content hidden">
      <div class="mb-6">
       <h3 class="text-2xl font-bold mb-2">Manajemen Keuangan</h3>
       <p style="color: var(--text-secondary);">Kelola pemasukan dan pengeluaran kas kelas</p>
      </div><!-- Finance Stats -->
      <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
       <div class="card-hover rounded-2xl p-6 shadow-sm border" style="background: var(--bg-primary); border-color: var(--border-color);">
        <div class="flex items-center justify-between mb-4">
         <div class="w-12 h-12 gradient-primary rounded-xl flex items-center justify-center shadow-lg shadow-sky-200">
          <svg class="w-6 h-6 text-white" fill="none" stroke="currentColor" viewbox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
          </svg>
         </div>
        </div>
        <p class="text-3xl font-bold mb-1" id="class-balance">Rp 0</p>
        <p style="color: var(--text-secondary);">Saldo Kas</p>
       </div>
       <div class="card-hover rounded-2xl p-6 shadow-sm border" style="background: var(--bg-primary); border-color: var(--border-color);">
        <div class="flex items-center justify-between mb-4">
         <div class="w-12 h-12 gradient-success rounded-xl flex items-center justify-center shadow-lg shadow-emerald-200">
          <svg class="w-6 h-6 text-white" fill="none" stroke="currentColor" viewbox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 11l5-5m0 0l5 5m-5-5v12" />
          </svg>
         </div>
        </div>
        <p class="text-3xl font-bold mb-1 text-emerald-600" id="class-income">Rp 0</p>
        <p style="color: var(--text-secondary);">Total Pemasukan</p>
       </div>
       <div class="card-hover rounded-2xl p-6 shadow-sm border" style="background: var(--bg-primary); border-color: var(--border-color);">
        <div class="flex items-center justify-between mb-4">
         <div class="w-12 h-12 gradient-danger rounded-xl flex items-center justify-center shadow-lg shadow-rose-200">
          <svg class="w-6 h-6 text-white" fill="none" stroke="currentColor" viewbox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 13l-5 5m0 0l-5-5m5 5V6" />
          </svg>
         </div>
        </div>
        <p class="text-3xl font-bold mb-1 text-rose-600" id="class-expense">Rp 0</p>
        <p style="color: var(--text-secondary);">Total Pengeluaran</p>
       </div>
      </div><!-- Finance Actions -->
      <div id="finance-actions" class="hidden mb-6 flex flex-wrap gap-3"><button onclick="openTransactionModal('income')" class="gradient-success text-white px-4 py-2.5 rounded-xl font-medium shadow-lg hover:shadow-xl transition-all flex items-center gap-2">
        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewbox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6" />
        </svg> Tambah Pemasukan </button> <button onclick="openTransactionModal('expense')" class="gradient-danger text-white px-4 py-2.5 rounded-xl font-medium shadow-lg hover:shadow-xl transition-all flex items-center gap-2">
        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewbox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20 12H4" />
        </svg> Tambah Pengeluaran </button> <button onclick="openFinanceHistoryModal()" class="gradient-purple text-white px-4 py-2.5 rounded-xl font-medium shadow-lg hover:shadow-xl transition-all flex items-center gap-2">
        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewbox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z" />
        </svg> Riwayat </button> <button onclick="openResetFinanceModal()" class="bg-amber-500 hover:bg-amber-600 text-white px-4 py-2.5 rounded-xl font-medium shadow-lg hover:shadow-xl transition-all flex items-center gap-2">
        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewbox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15" />
        </svg> Reset Keuangan </button>
      </div><!-- Transaction History -->
      <div class="rounded-2xl border" style="background: var(--bg-primary); border-color: var(--border-color);">
       <div class="p-6 border-b" style="border-color: var(--border-color);">
        <h4 class="font-bold text-lg">Riwayat Transaksi</h4>
       </div>
       <div id="transactions-list" class="divide-y" style="border-color: var(--border-color);">
        <div class="p-8 text-center" style="color: var(--text-secondary);">
         <svg class="w-12 h-12 mx-auto mb-3 opacity-50" fill="none" stroke="currentColor" viewbox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2" />
         </svg>
         <p>Belum ada transaksi</p>
        </div>
       </div>
      </div>
     </div><!-- Members Tab -->
     <div id="class-tab-members" class="class-tab-content hidden">
      <div class="flex items-center justify-between mb-6">
       <div>
        <h3 class="text-2xl font-bold">Anggota Kelas</h3>
        <p style="color: var(--text-secondary);">Daftar anggota dan role kelas</p>
       </div><button id="add-member-btn" onclick="openAddMemberModal()" class="hidden gradient-primary text-white px-4 py-2.5 rounded-xl font-medium shadow-lg hover:shadow-xl transition-all flex items-center gap-2">
        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewbox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6" />
        </svg> Tambah Anggota </button>
      </div>
      <div id="class-members-list" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
       <div class="col-span-full rounded-2xl border p-8 text-center" style="color: var(--text-secondary); background: var(--bg-primary); border-color: var(--border-color);">
        <svg class="w-12 h-12 mx-auto mb-3 opacity-50" fill="none" stroke="currentColor" viewbox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4.354a4 4 0 110 5.292M15 21H3v-1a6 6 0 0112 0v1zm0 0h6v-1a6 6 0 00-9-5.197M13 7a4 4 0 11-8 0 4 4 0 018 0z" />
        </svg>
        <p>Belum ada anggota</p>
       </div>
      </div>
     </div><!-- Chat Tab -->
     <div id="class-tab-chat" class="class-tab-content hidden">
      <div class="rounded-2xl border h-[600px] flex flex-col" style="background: var(--bg-primary); border-color: var(--border-color);">
       <div class="p-4 border-b" style="border-color: var(--border-color);">
        <h4 class="font-bold">Chat Kelas</h4>
       </div>
       <div id="chat-messages" class="flex-1 overflow-auto scrollbar-thin p-4 space-y-4">
        <div class="text-center py-8" style="color: var(--text-secondary);">
         <svg class="w-12 h-12 mx-auto mb-3 opacity-50" fill="none" stroke="currentColor" viewbox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z" />
         </svg>
         <p>Belum ada pesan</p>
        </div>
       </div>
       <form id="chat-form" onsubmit="handleSendMessage(event)" class="p-4 border-t" style="border-color: var(--border-color);">
        <div class="flex gap-2"><input type="text" id="chat-input" placeholder="Ketik pesan..." class="flex-1 px-4 py-2 rounded-xl border focus:ring-2 focus:ring-sky-500 focus:border-sky-500" style="background: var(--bg-secondary); border-color: var(--border-color); color: var(--text-primary);"> <button type="submit" class="gradient-primary text-white px-4 py-2 rounded-xl font-medium hover:shadow-lg transition-all">
          <svg class="w-5 h-5" fill="none" stroke="currentColor" viewbox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 19l9 2-9-18-9 18 9-2zm0 0v-8" />
          </svg></button>
        </div>
       </form>
      </div>
     </div><!-- Billing Tab (Treasurer - Create Bills, Others - View Bills) -->
     <div id="class-tab-billing" class="class-tab-content hidden"><!-- Treasurer View -->
      <div id="billing-treasurer-view" class="hidden">
       <div class="flex items-center justify-between mb-6">
        <div>
         <h3 class="text-2xl font-bold">Tagihan Kas</h3>
         <p style="color: var(--text-secondary);">Kelola tagihan kas untuk anggota kelas</p>
        </div><button onclick="openCreateBillingModal()" class="gradient-primary text-white px-4 py-2.5 rounded-xl font-medium shadow-lg hover:shadow-xl transition-all flex items-center gap-2">
         <svg class="w-5 h-5" fill="none" stroke="currentColor" viewbox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6" />
         </svg> Buat Tagihan Baru </button>
       </div>
       <div id="billing-setup-info" class="mb-6"></div>
       <div id="billing-table-container" class="overflow-auto scrollbar-thin"></div>
      </div><!-- Member View -->
      <div id="billing-member-view" class="hidden">
       <div class="mb-6">
        <h3 class="text-2xl font-bold mb-2">Tagihan Saya</h3>
        <p style="color: var(--text-secondary);">Informasi tagihan kas Anda</p>
       </div>
       <div id="member-billing-card" class="rounded-2xl p-6 shadow-sm border mb-6" style="background: var(--bg-primary); border-color: var(--border-color);">
        <div class="flex items-center justify-between mb-4">
         <div>
          <p class="text-sm" style="color: var(--text-secondary);">Total Tagihan</p>
          <p id="member-total-bill" class="text-4xl font-bold text-rose-600">Rp 0</p>
         </div>
         <div class="w-16 h-16 gradient-danger rounded-xl flex items-center justify-center shadow-lg">
          <svg class="w-8 h-8 text-white" fill="none" stroke="currentColor" viewbox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
          </svg>
         </div>
        </div>
        <div class="grid grid-cols-2 gap-4 text-sm">
         <div>
          <p style="color: var(--text-secondary);">Sudah Dibayar</p>
          <p id="member-paid-periods" class="font-bold text-emerald-600">0 periode</p>
         </div>
         <div>
          <p style="color: var(--text-secondary);">Belum Dibayar</p>
          <p id="member-unpaid-periods" class="font-bold text-rose-600">0 periode</p>
         </div>
        </div>
       </div>
       <div id="member-billing-history" class="rounded-2xl border" style="background: var(--bg-primary); border-color: var(--border-color);">
        <div class="p-6 border-b" style="border-color: var(--border-color);">
         <h4 class="font-bold text-lg">Riwayat Pembayaran</h4>
        </div>
        <div id="member-payment-history" class="p-4">
         <div class="text-center py-8" style="color: var(--text-secondary);">
          <p>Belum ada tagihan</p>
         </div>
        </div>
       </div>
      </div>
     </div>
    </div>
   </div>
  </div><!-- Modal Container -->
  <div id="modal-container" class="hidden fixed inset-0 z-50 overflow-auto" onclick="handleModalBackdropClick(event)">
   <div class="min-h-full flex items-center justify-center p-4">
    <div id="modal-content" class="modal-content rounded-2xl shadow-2xl w-full max-w-2xl max-h-[90vh] overflow-auto relative" style="background: var(--bg-primary);" onclick="event.stopPropagation()"><!-- Modal content will be injected here -->
    </div>
   </div>
  </div>
  <script>
    // ==================== CONFIG & STATE ====================
    const defaultConfig = {
      app_title: 'Kassify',
      welcome_message: 'Selamat Datang',
      primary_color: '#0ea5e9',
      secondary_color: '#f1f5f9',
      text_color: '#1e293b',
      accent_color: '#10b981',
      danger_color: '#f43f5e'
    };

    let config = { ...defaultConfig };
    let allData = [];
    let currentUser = null;
    let currentClass = null;
    let isDarkMode = false;
    let notificationFilter = 'unread';

    // Role permissions
    const ROLES = {
      admin: { level: 5, label: 'Admin', canAddMember: true, canEdit: true, canDelete: true, canManageFinance: false, canManageTasks: false, canProposeFinance: true, canProposeTasks: true },
      ketua: { level: 4, label: 'Ketua Kelas', canAddMember: true, canEdit: true, canDelete: true, canManageFinance: false, canManageTasks: false, canProposeFinance: true, canProposeTasks: true },
      wakil_ketua: { level: 3, label: 'Wakil Ketua', canAddMember: false, canEdit: false, canDelete: false, canManageFinance: false, canManageTasks: false },
      bendahara: { level: 2, label: 'Bendahara', canAddMember: false, canEdit: false, canDelete: false, canManageFinance: true, canManageTasks: false, canManageBilling: true },
      sekretaris: { level: 2, label: 'Sekretaris', canAddMember: false, canEdit: false, canDelete: false, canManageFinance: false, canManageTasks: true },
      anggota: { level: 1, label: 'Anggota', canAddMember: false, canEdit: false, canDelete: false, canManageFinance: false, canManageTasks: false }
    };

    // Welcome messages
    const WELCOME_MESSAGES = [
      'Selamat Datang',
      'Halo',
      'Hai',
      'Selamat Pagi',
      'Selamat Siang',
      'Selamat Sore',
      'Selamat Malam',
      'Apa Kabar',
      'Semangat',
      'Have a great day'
    ];

    // ==================== ELEMENT SDK ====================
    async function initElementSdk() {
      if (window.elementSdk) {
        await window.elementSdk.init({
          defaultConfig,
          onConfigChange: async (newConfig) => {
            config = { ...defaultConfig, ...newConfig };
            updateUIColors();
          },
          mapToCapabilities: (cfg) => ({
            recolorables: [
              {
                get: () => cfg.primary_color || defaultConfig.primary_color,
                set: (v) => window.elementSdk.setConfig({ primary_color: v })
              },
              {
                get: () => cfg.secondary_color || defaultConfig.secondary_color,
                set: (v) => window.elementSdk.setConfig({ secondary_color: v })
              },
              {
                get: () => cfg.text_color || defaultConfig.text_color,
                set: (v) => window.elementSdk.setConfig({ text_color: v })
              },
              {
                get: () => cfg.accent_color || defaultConfig.accent_color,
                set: (v) => window.elementSdk.setConfig({ accent_color: v })
              },
              {
                get: () => cfg.danger_color || defaultConfig.danger_color,
                set: (v) => window.elementSdk.setConfig({ danger_color: v })
              }
            ],
            borderables: [],
            fontEditable: undefined,
            fontSizeable: undefined
          }),
          mapToEditPanelValues: (cfg) => new Map([
            ['app_title', cfg.app_title || defaultConfig.app_title],
            ['welcome_message', cfg.welcome_message || defaultConfig.welcome_message]
          ])
        });
        config = { ...defaultConfig, ...window.elementSdk.config };
      }
    }

    // ==================== DATA SDK ====================
    const dataHandler = {
      onDataChanged(data) {
        allData = data || [];
        
        // Update notification badge immediately when data changes
        if (currentUser) {
          const userNotifs = allData.filter(d => 
            d.type === 'notification' && 
            d.target_id === currentUser.id &&
            !d.is_read
          );
          updateNotificationBadge(userNotifs.length);
        }
        
        // Only update UI if we're on the respective pages
        const currentPage = document.querySelector('.page:not(.hidden)');
        if (!currentPage) return;
        
        const pageId = currentPage.id;
        
        if (pageId === 'page-home' && currentUser) {
          updateHomeData();
          renderNotifications();
        }
        
        if (pageId === 'page-class' && currentClass) {
          updateClassData();
        }
      }
    };

    async function initDataSdk() {
      if (window.dataSdk) {
        const result = await window.dataSdk.init(dataHandler);
        if (!result.isOk) {
          showToast('Gagal menghubungkan ke database', 'error');
        }
      }
    }

    // ==================== UTILITIES ====================
    function showLoading(show = true) {
      document.getElementById('loading-overlay').classList.toggle('hidden', !show);
    }

    function formatCurrency(amount) {
      return new Intl.NumberFormat('id-ID', {
        style: 'currency',
        currency: 'IDR',
        minimumFractionDigits: 0,
        maximumFractionDigits: 0
      }).format(amount);
    }

    function formatDate(dateStr) {
      const date = new Date(dateStr);
      return date.toLocaleDateString('id-ID', {
        day: 'numeric',
        month: 'short',
        year: 'numeric',
        hour: '2-digit',
        minute: '2-digit'
      });
    }

    function formatDateShort(dateStr) {
      const date = new Date(dateStr);
      return date.toLocaleDateString('id-ID', {
        day: 'numeric',
        month: 'short'
      });
    }

    function generateId() {
      return Date.now().toString(36) + Math.random().toString(36).substr(2);
    }

    function getInitials(name) {
      return name.split(' ').map(n => n[0]).join('').substring(0, 2).toUpperCase();
    }

    function showToast(message, type = 'success') {
      const container = document.getElementById('toast-container');
      const toast = document.createElement('div');
      const bgColor = type === 'success' ? 'bg-emerald-500' : type === 'error' ? 'bg-rose-500' : 'bg-sky-500';
      const icon = type === 'success' 
        ? '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/>'
        : type === 'error'
        ? '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>'
        : '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/>';
      
      toast.className = `toast ${bgColor} text-white px-4 py-3 rounded-xl shadow-lg flex items-center gap-3 min-w-[280px]`;
      toast.innerHTML = `
        <svg class="w-5 h-5 shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">${icon}</svg>
        <span class="flex-1">${message}</span>
        <button onclick="this.parentElement.remove()" class="hover:opacity-70">
          <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
          </svg>
        </button>
      `;
      container.appendChild(toast);
      setTimeout(() => toast.remove(), 4000);
    }

    function updateDateTime() {
      const now = new Date();
      const options = { 
        weekday: 'long', 
        year: 'numeric', 
        month: 'long', 
        day: 'numeric',
        hour: '2-digit',
        minute: '2-digit'
      };
      document.getElementById('current-date-time').textContent = now.toLocaleDateString('id-ID', options);
    }

    function getRandomWelcome() {
      const hour = new Date().getHours();
      let timeBasedMessages = [];
      
      if (hour >= 5 && hour < 11) {
        timeBasedMessages = ['Selamat Pagi', 'Pagi yang Cerah', 'Good Morning'];
      } else if (hour >= 11 && hour < 15) {
        timeBasedMessages = ['Selamat Siang', 'Good Afternoon'];
      } else if (hour >= 15 && hour < 18) {
        timeBasedMessages = ['Selamat Sore', 'Good Evening'];
      } else {
        timeBasedMessages = ['Selamat Malam', 'Good Night'];
      }
      
      const allMessages = [...WELCOME_MESSAGES, ...timeBasedMessages];
      return allMessages[Math.floor(Math.random() * allMessages.length)];
    }

    // ==================== DARK MODE ====================
    function toggleDarkMode() {
      isDarkMode = !isDarkMode;
      document.body.classList.toggle('dark-mode', isDarkMode);
      
      const icon = document.getElementById('dark-mode-icon');
      if (isDarkMode) {
        icon.innerHTML = '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 3v1m0 16v1m9-9h-1M4 12H3m15.364 6.364l-.707-.707M6.343 6.343l-.707-.707m12.728 0l-.707.707M6.343 17.657l-.707.707M16 12a4 4 0 11-8 0 4 4 0 018 0z"/>';
      } else {
        icon.innerHTML = '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20.354 15.354A9 9 0 018.646 3.646 9.003 9.003 0 0012 21a9.003 9.003 0 008.354-5.646z"/>';
      }
      
      showToast(`Mode ${isDarkMode ? 'gelap' : 'terang'} diaktifkan`, 'info');
    }

    // ==================== AUTH ====================
    function showLoginForm() {
      document.getElementById('login-form-container').classList.remove('hidden');
      document.getElementById('register-form-container').classList.add('hidden');
    }

    function showRegisterForm() {
      document.getElementById('login-form-container').classList.add('hidden');
      document.getElementById('register-form-container').classList.remove('hidden');
    }

    async function handleLogin(e) {
      e.preventDefault();
      showLoading();
      
      const username = document.getElementById('login-username').value.trim();
      const password = document.getElementById('login-password').value;
      
      // Simulate network delay
      await new Promise(resolve => setTimeout(resolve, 1000));
      
      const user = allData.find(d => 
        d.type === 'user' && 
        (d.username === username || d.email === username) && 
        d.password === password
      );
      
      showLoading(false);
      
      if (user) {
        currentUser = user;
        showToast(`Selamat datang kembali, ${user.full_name}!`, 'success');
        navigateToHome();
      } else {
        showToast('Username/email atau password salah', 'error');
      }
    }

    async function handleRegister(e) {
      e.preventDefault();
      
      if (allData.length >= 999) {
        showToast('Batas maksimum pengguna tercapai', 'error');
        return;
      }
      
      showLoading();
      
      const fullName = document.getElementById('register-fullname').value.trim();
      const username = document.getElementById('register-username').value.trim();
      const email = document.getElementById('register-email').value.trim();
      const password = document.getElementById('register-password').value;
      
      // Check if username or email exists
      const exists = allData.find(d => 
        d.type === 'user' && (d.username === username || d.email === email)
      );
      
      if (exists) {
        showLoading(false);
        showToast('Username atau email sudah digunakan', 'error');
        return;
      }
      
      const newUser = {
        id: generateId(),
        type: 'user',
        username,
        email,
        password,
        full_name: fullName,
        phone: '',
        avatar: '',
        created_at: new Date().toISOString(),
        status: 'active'
      };
      
      const result = await window.dataSdk.create(newUser);
      showLoading(false);
      
      if (result.isOk) {
        showToast(`Akun berhasil dibuat! Silakan masuk dengan akun Anda.`, 'success');
        document.getElementById('register-form').reset();
        showLoginForm();
      } else {
        showToast('Gagal membuat akun', 'error');
      }
    }

    function handleLogout() {
      currentUser = null;
      currentClass = null;
      navigateToPage('login');
      showToast('Anda telah keluar', 'info');
      toggleProfileMenu();
    }

    // ==================== NAVIGATION ====================
    function navigateToPage(pageName) {
      document.querySelectorAll('.page').forEach(p => p.classList.add('hidden'));
      document.getElementById(`page-${pageName}`).classList.remove('hidden');
    }

    function navigateToHome() {
      navigateToPage('home');
      updateHomeData();
      updateDateTime();
      setInterval(updateDateTime, 60000);
      
      const welcomeText = config.welcome_message || getRandomWelcome();
      document.getElementById('welcome-text').textContent = welcomeText;
      document.getElementById('welcome-username').textContent = currentUser.full_name;
      document.getElementById('nav-username').textContent = currentUser.username;
      document.getElementById('nav-avatar').textContent = getInitials(currentUser.full_name);
      document.getElementById('home-app-title').textContent = config.app_title || defaultConfig.app_title;
    }

    function navigateToClass(classId) {
      const classMembership = allData.find(d => 
        d.type === 'class_member' && 
        d.class_id === classId && 
        d.user_id === currentUser.id
      );
      
      if (!classMembership) {
        showToast('Anda bukan anggota kelas ini', 'error');
        return;
      }
      
      const classData = allData.find(d => d.type === 'class' && d.id === classId);
      if (!classData) {
        showToast('Kelas tidak ditemukan', 'error');
        return;
      }
      
      currentClass = {
        ...classData,
        userRole: classMembership.role
      };
      
      navigateToPage('class');
      updateClassData();
    }

    function backToHome() {
      currentClass = null;
      navigateToHome();
    }

    function scrollToClasses() {
      const section = document.getElementById('classes-section');
      section.scrollIntoView({ behavior: 'smooth', block: 'start' });
    }

    // ==================== PROFILE ====================
    function toggleProfileMenu() {
      const menu = document.getElementById('profile-menu');
      menu.classList.toggle('hidden');
      
      // Close when clicking outside
      if (!menu.classList.contains('hidden')) {
        setTimeout(() => {
          document.addEventListener('click', function closeMenu(e) {
            if (!menu.contains(e.target) && !e.target.closest('button[onclick="toggleProfileMenu()"]')) {
              menu.classList.add('hidden');
              document.removeEventListener('click', closeMenu);
            }
          });
        }, 100);
      }
    }

    function openProfileModal() {
      toggleProfileMenu();
      
      const avatarEmojis = ['ðŸ˜€', 'ðŸ˜Ž', 'ðŸ¤“', 'ðŸ˜Š', 'ðŸ¥³', 'ðŸš€', 'â­', 'ðŸŽ¨', 'ðŸŽ¯', 'ðŸ’Ž', 'ðŸ”¥', 'âœ¨', 'ðŸŒŸ', 'ðŸ’ª', 'ðŸ‘‘', 'ðŸŽ­', 'ðŸŽ¸', 'ðŸŽ®', 'ðŸ“š', 'âš¡'];
      
      const html = `
        <div class="p-6">
          <div class="flex items-center justify-between mb-6">
            <h3 class="text-xl font-bold">Edit Profil</h3>
            <button onclick="closeModal()" class="p-2 rounded-lg hover:bg-opacity-10" style="background: var(--hover-bg);">
              <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
              </svg>
            </button>
          </div>
          <form id="profile-form" onsubmit="handleUpdateProfile(event)">
            <div class="space-y-4">
              <div>
                <label class="block text-sm font-medium mb-2" style="color: var(--text-secondary);">Foto Profil</label>
                <div class="flex items-center gap-4 mb-3">
                  <div id="profile-avatar-preview" class="w-20 h-20 bg-gradient-to-br from-sky-400 to-sky-600 rounded-full flex items-center justify-center text-white font-bold text-2xl shadow-lg">
                    ${currentUser.avatar || getInitials(currentUser.full_name)}
                  </div>
                  <button type="button" onclick="toggleAvatarPicker()" class="px-4 py-2 rounded-lg border text-sm font-medium hover:bg-opacity-10 transition-all" style="border-color: var(--border-color);">
                    Pilih Emoji
                  </button>
                </div>
                <div id="avatar-picker" class="hidden grid grid-cols-10 gap-2 p-3 rounded-xl border" style="background: var(--bg-secondary); border-color: var(--border-color);">
                  ${avatarEmojis.map(emoji => `
                    <button type="button" onclick="selectAvatar('${emoji}')" class="w-10 h-10 text-2xl hover:bg-opacity-20 rounded-lg transition-all flex items-center justify-center" style="background: var(--hover-bg);">
                      ${emoji}
                    </button>
                  `).join('')}
                </div>
                <input type="hidden" id="profile-avatar" value="${currentUser.avatar || ''}">
              </div>
              <div>
                <label for="profile-fullname" class="block text-sm font-medium mb-2" style="color: var(--text-secondary);">Nama Lengkap</label>
                <input type="text" id="profile-fullname" value="${currentUser.full_name}" required class="w-full px-4 py-3 rounded-xl border focus:ring-2 focus:ring-sky-500" style="background: var(--bg-secondary); border-color: var(--border-color); color: var(--text-primary);">
              </div>
              <div>
                <label for="profile-phone" class="block text-sm font-medium mb-2" style="color: var(--text-secondary);">No. HP</label>
                <input type="tel" id="profile-phone" value="${currentUser.phone || ''}" placeholder="08xxxxxxxxxx" class="w-full px-4 py-3 rounded-xl border focus:ring-2 focus:ring-sky-500" style="background: var(--bg-secondary); border-color: var(--border-color); color: var(--text-primary);">
              </div>
              <div>
                <label for="profile-email" class="block text-sm font-medium mb-2" style="color: var(--text-secondary);">Email</label>
                <input type="email" id="profile-email" value="${currentUser.email}" required class="w-full px-4 py-3 rounded-xl border focus:ring-2 focus:ring-sky-500" style="background: var(--bg-secondary); border-color: var(--border-color); color: var(--text-primary);">
              </div>
            </div>
            <button type="submit" class="w-full gradient-primary text-white py-3 rounded-xl font-semibold mt-6 hover:shadow-lg transition-all">
              Simpan Perubahan
            </button>
          </form>
        </div>
      `;
      
      openModal(html);
    }
    
    function toggleAvatarPicker() {
      const picker = document.getElementById('avatar-picker');
      picker.classList.toggle('hidden');
    }
    
    function selectAvatar(emoji) {
      document.getElementById('profile-avatar').value = emoji;
      document.getElementById('profile-avatar-preview').textContent = emoji;
      toggleAvatarPicker();
    }

    async function handleUpdateProfile(e) {
      e.preventDefault();
      showLoading();
      
      const fullName = document.getElementById('profile-fullname').value.trim();
      const phone = document.getElementById('profile-phone').value.trim();
      const email = document.getElementById('profile-email').value.trim();
      const avatar = document.getElementById('profile-avatar').value;
      
      const updatedUser = {
        ...currentUser,
        full_name: fullName,
        phone,
        email,
        avatar,
        updated_at: new Date().toISOString()
      };
      
      const result = await window.dataSdk.update(updatedUser);
      showLoading(false);
      
      if (result.isOk) {
        currentUser = updatedUser;
        showToast('Profil berhasil diperbarui', 'success');
        closeModal();
        
        // Update UI
        document.getElementById('nav-username').textContent = currentUser.username;
        const navAvatar = document.getElementById('nav-avatar');
        if (currentUser.avatar) {
          navAvatar.textContent = currentUser.avatar;
          navAvatar.className = 'w-8 h-8 bg-gradient-to-br from-sky-400 to-sky-600 rounded-full flex items-center justify-center text-white text-xl';
        } else {
          navAvatar.textContent = getInitials(currentUser.full_name);
          navAvatar.className = 'w-8 h-8 bg-gradient-to-br from-sky-400 to-sky-600 rounded-full flex items-center justify-center text-white font-bold text-sm';
        }
        document.getElementById('welcome-username').textContent = currentUser.full_name;
      } else {
        showToast('Gagal memperbarui profil', 'error');
      }
    }

    // ==================== NOTIFICATIONS ====================
    function toggleNotificationPanel() {
      const panel = document.getElementById('notification-panel');
      panel.classList.toggle('hidden');
      
      if (!panel.classList.contains('hidden')) {
        renderNotifications();
        
        setTimeout(() => {
          document.addEventListener('click', function closePanel(e) {
            if (!panel.contains(e.target) && !e.target.closest('button[onclick="toggleNotificationPanel()"]')) {
              panel.classList.add('hidden');
              document.removeEventListener('click', closePanel);
            }
          });
        }, 100);
      }
    }

    function filterNotifications(filter) {
      notificationFilter = filter;
      
      document.querySelectorAll('.notif-filter-btn').forEach(btn => {
        if (btn.dataset.filter === filter) {
          if (filter === 'unread') {
            btn.className = 'notif-filter-btn flex-1 px-3 py-2 rounded-lg text-sm font-medium transition-all bg-sky-500 text-white';
          } else {
            btn.className = 'notif-filter-btn flex-1 px-3 py-2 rounded-lg text-sm font-medium transition-all bg-emerald-500 text-white';
          }
        } else {
          btn.className = 'notif-filter-btn flex-1 px-3 py-2 rounded-lg text-sm font-medium transition-all';
          btn.style.background = 'var(--hover-bg)';
          btn.style.color = 'var(--text-primary)';
        }
      });
      
      renderNotifications();
    }
    
    async function deleteNotification(notifId) {
      showLoading();
      const notif = allData.find(d => d.__backendId === notifId);
      if (notif) {
        await window.dataSdk.delete(notif);
        showToast('Notifikasi dihapus', 'success');
      }
      showLoading(false);
    }

    function renderNotifications() {
      if (!currentUser) return;
      
      const userNotifs = allData.filter(d => 
        d.type === 'notification' && 
        d.target_id === currentUser.id
      );
      
      // Update badge count immediately based on unread notifications
      const unreadCount = userNotifs.filter(n => !n.is_read).length;
      updateNotificationBadge(unreadCount);
      
      let filtered = userNotifs;
      if (notificationFilter === 'unread') {
        filtered = userNotifs.filter(n => !n.is_read);
      } else if (notificationFilter === 'read') {
        filtered = userNotifs.filter(n => n.is_read);
      }
      
      const sorted = filtered.sort((a, b) => new Date(b.created_at) - new Date(a.created_at));
      
      const container = document.getElementById('notification-list');
      
      if (sorted.length === 0) {
        container.innerHTML = `
          <div class="p-8 text-center" style="color: var(--text-secondary);">
            <svg class="w-12 h-12 mx-auto mb-3 opacity-50" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 17h5l-1.405-1.405A2.032 2.032 0 0118 14.158V11a6.002 6.002 0 00-4-5.659V5a2 2 0 10-4 0v.341C7.67 6.165 6 8.388 6 11v3.159c0 .538-.214 1.055-.595 1.436L4 17h5m6 0v1a3 3 0 11-6 0v-1m6 0H9"/>
            </svg>
            <p>Tidak ada notifikasi</p>
          </div>
        `;
        return;
      }
      
      container.innerHTML = sorted.map(notif => {
        const iconClass = notif.action === 'invite' ? 'bg-sky-100 text-sky-600' 
          : notif.action === 'approve' ? 'bg-emerald-100 text-emerald-600'
          : notif.action === 'recommend' ? 'bg-purple-100 text-purple-600'
          : notif.action === 'leave_request' ? 'bg-amber-100 text-amber-600'
          : 'bg-slate-100 text-slate-600';
        
        return `
          <div class="p-4 rounded-xl transition-all ${notif.is_read ? 'opacity-60' : 'border-l-4 border-l-sky-500'}" style="background: var(--hover-bg);">
            <div class="flex items-start gap-3">
              <div class="w-10 h-10 ${iconClass} rounded-xl flex items-center justify-center shrink-0">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 17h5l-1.405-1.405A2.032 2.032 0 0118 14.158V11a6.002 6.002 0 00-4-5.659V5a2 2 0 10-4 0v.341C7.67 6.165 6 8.388 6 11v3.159c0 .538-.214 1.055-.595 1.436L4 17h5m6 0v1a3 3 0 11-6 0v-1m6 0H9"/>
                </svg>
              </div>
              <div class="flex-1 min-w-0 cursor-pointer" onclick="handleNotificationClick('${notif.__backendId}')">
                <p class="font-medium text-sm">${notif.message}</p>
                <p class="text-xs mt-1" style="color: var(--text-secondary);">${formatDate(notif.created_at)}</p>
              </div>
              ${notif.is_read ? `
                <button onclick="event.stopPropagation(); deleteNotification('${notif.__backendId}')" class="p-2 rounded-lg hover:bg-rose-100 text-rose-600 transition-all shrink-0">
                  <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"/>
                  </svg>
                </button>
              ` : ''}
            </div>
          </div>
        `;
      }).join('');
    }
    
    function updateNotificationBadge(count) {
      const badge = document.getElementById('home-notif-badge');
      if (count > 0) {
        badge.textContent = count > 9 ? '9+' : count;
        badge.classList.remove('hidden');
      } else {
        badge.classList.add('hidden');
      }
    }

    async function handleNotificationClick(notifId) {
      const notif = allData.find(d => d.__backendId === notifId);
      if (!notif) return;
      
      if (!notif.is_read) {
        const updatedNotif = { ...notif, is_read: true };
        await window.dataSdk.update(updatedNotif);
      }
      
      if (notif.action === 'invite' && notif.target_type === 'class') {
        openClassInviteModal(notif);
      } else if (notif.action === 'recommend' && notif.target_type === 'class') {
        openMemberRecommendModal(notif);
      } else if (notif.action === 'leave_request') {
        openLeaveRequestModal(notif);
      } else if (notif.action === 'task') {
        toggleNotificationPanel();
        openTaskDetailModal(notif);
      } else if (notif.action === 'message') {
        toggleNotificationPanel();
        navigateToClass(notif.class_id);
        switchClassTab('chat');
      } else if (notif.target_type === 'class') {
        toggleNotificationPanel();
        navigateToClass(notif.class_id);
      }
    }
    
    function openTaskDetailModal(notif) {
      const task = allData.find(d => d.type === 'task' && d.class_id === notif.class_id);
      
      if (!task) {
        showToast('Tugas tidak ditemukan', 'error');
        return;
      }
      
      const html = `
        <div class="p-6">
          <div class="flex items-center justify-between mb-6">
            <h3 class="text-xl font-bold">Detail Tugas</h3>
            <button onclick="closeModal()" class="p-2 rounded-lg hover:bg-opacity-10" style="background: var(--hover-bg);">
              <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
              </svg>
            </button>
          </div>
          
          <div class="mb-6">
            <div class="p-4 rounded-xl border mb-4" style="background: var(--bg-secondary); border-color: var(--border-color);">
              <h4 class="font-bold text-lg mb-2">${task.task_title}</h4>
              <p class="mb-3" style="color: var(--text-secondary);">${task.task_description}</p>
              <div class="flex items-center gap-4 text-sm">
                <div class="flex items-center gap-1">
                  <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24" style="color: var(--text-secondary);">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"/>
                  </svg>
                  <span style="color: var(--text-secondary);">Tenggat: ${formatDateShort(task.task_due_date)}</span>
                </div>
                <div class="flex items-center gap-1">
                  <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24" style="color: var(--text-secondary);">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"/>
                  </svg>
                  <span style="color: var(--text-secondary);">Oleh: ${task.created_by}</span>
                </div>
              </div>
            </div>
          </div>
          
          <button onclick="navigateToClassFromModal('${notif.class_id}')" class="w-full gradient-primary text-white py-3 rounded-xl font-semibold hover:shadow-lg transition-all">
            Buka Kelas
          </button>
        </div>
      `;
      
      openModal(html);
    }
    
    function navigateToClassFromModal(classId) {
      closeModal();
      navigateToClass(classId);
      switchClassTab('info');
    }

    async function createNotification(targetId, message, action, targetType, classId = '') {
      const notif = {
        id: generateId(),
        type: 'notification',
        target_id: targetId,
        target_type: targetType,
        message,
        action,
        class_id: classId,
        is_read: false,
        created_at: new Date().toISOString()
      };
      
      await window.dataSdk.create(notif);
    }

    // ==================== HOME DATA ====================
    function updateHomeData() {
      const userClasses = allData.filter(d => 
        d.type === 'class_member' && 
        d.user_id === currentUser.id
      );
      
      document.getElementById('total-classes').textContent = userClasses.length;
      
      // Count tasks from all classes
      let totalTasks = 0;
      userClasses.forEach(membership => {
        const classTasks = allData.filter(d => 
          d.type === 'task' && 
          d.class_id === membership.class_id
        );
        totalTasks += classTasks.length;
      });
      document.getElementById('total-tasks').textContent = totalTasks;
      
      // Count unread messages (messages from others that user hasn't read in classes they're in)
      let unreadMessages = 0;
      userClasses.forEach(membership => {
        const classMessages = allData.filter(d => 
          d.type === 'message' && 
          d.class_id === membership.class_id &&
          d.sender_id !== currentUser.id &&
          !d.is_read
        );
        unreadMessages += classMessages.length;
      });
      document.getElementById('total-messages').textContent = unreadMessages;
      
      renderClassesGrid();
    }

    function renderClassesGrid() {
      const userClasses = allData.filter(d => 
        d.type === 'class_member' && 
        d.user_id === currentUser.id
      );
      
      const container = document.getElementById('classes-grid');
      
      if (userClasses.length === 0) {
        container.innerHTML = `
          <div class="col-span-full p-8 text-center rounded-2xl border" style="color: var(--text-secondary); background: var(--bg-primary); border-color: var(--border-color);">
            <svg class="w-12 h-12 mx-auto mb-3 opacity-50" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 011-1h2a1 1 0 011 1v5m-4 0h4"/>
            </svg>
            <p>Belum ada kelas. Buat kelas baru atau tunggu undangan!</p>
          </div>
        `;
        return;
      }
      
      container.innerHTML = userClasses.map(membership => {
        const classData = allData.find(d => d.type === 'class' && d.id === membership.class_id);
        if (!classData) return '';
        
        const members = allData.filter(d => d.type === 'class_member' && d.class_id === classData.id);
        const roleInfo = ROLES[membership.role] || ROLES.anggota;
        
        const gradients = ['gradient-primary', 'gradient-success', 'gradient-warning', 'gradient-purple'];
        const gradient = gradients[Math.floor(Math.random() * gradients.length)];
        
        return `
          <div onclick="navigateToClass('${classData.id}')" class="card-hover rounded-2xl shadow-sm border cursor-pointer overflow-hidden" style="background: var(--bg-primary); border-color: var(--border-color);">
            <div class="${gradient} h-24 flex items-center justify-center">
              <div class="text-white text-4xl font-bold">${classData.class_name.substring(0, 2).toUpperCase()}</div>
            </div>
            <div class="p-6">
              <div class="flex items-start justify-between mb-3">
                <h4 class="font-bold text-lg">${classData.class_name}</h4>
                <span class="text-xs px-2 py-1 rounded-full bg-sky-100 text-sky-600">${roleInfo.label}</span>
              </div>
              <p class="text-sm mb-4" style="color: var(--text-secondary);">${classData.class_description || 'Tidak ada deskripsi'}</p>
              <div class="flex items-center justify-between text-sm" style="color: var(--text-secondary);">
                <div class="flex items-center gap-1">
                  <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4.354a4 4 0 110 5.292M15 21H3v-1a6 6 0 0112 0v1zm0 0h6v-1a6 6 0 00-9-5.197M13 7a4 4 0 11-8 0 4 4 0 018 0z"/>
                  </svg>
                  <span>${members.length} anggota</span>
                </div>
                <span class="text-xs">${formatDateShort(classData.created_at)}</span>
              </div>
            </div>
          </div>
        `;
      }).join('');
    }

    // ==================== TASKS & MESSAGES POPUP ====================
    function openTasksPopup() {
      const userClasses = allData.filter(d => 
        d.type === 'class_member' && 
        d.user_id === currentUser.id
      );
      
      let allTasks = [];
      userClasses.forEach(membership => {
        const classData = allData.find(d => d.type === 'class' && d.id === membership.class_id);
        const classTasks = allData.filter(d => 
          d.type === 'task' && 
          d.class_id === membership.class_id
        );
        
        classTasks.forEach(task => {
          allTasks.push({
            ...task,
            className: classData ? classData.class_name : 'Kelas Tidak Diketahui'
          });
        });
      });
      
      allTasks.sort((a, b) => new Date(a.task_due_date) - new Date(b.task_due_date));
      
      const html = `
        <div class="p-6">
          <div class="flex items-center justify-between mb-6">
            <h3 class="text-xl font-bold">Tugas Saya</h3>
            <button onclick="closeModal()" class="p-2 rounded-lg hover:bg-opacity-10" style="background: var(--hover-bg);">
              <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
              </svg>
            </button>
          </div>
          
          ${allTasks.length === 0 ? `
            <div class="p-8 text-center" style="color: var(--text-secondary);">
              <svg class="w-12 h-12 mx-auto mb-3 opacity-50" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-6 9l2 2 4-4"/>
              </svg>
              <p>Tidak ada tugas</p>
            </div>
          ` : `
            <div class="space-y-3">
              ${allTasks.map(task => `
                <div onclick="navigateToClassTask('${task.class_id}')" class="p-4 rounded-xl cursor-pointer hover:bg-opacity-50 transition-all border" style="background: var(--hover-bg); border-color: var(--border-color);">
                  <div class="flex items-start justify-between mb-2">
                    <h4 class="font-semibold">${task.task_title}</h4>
                    <span class="text-xs px-2 py-1 rounded-full bg-amber-100 text-amber-600">${formatDateShort(task.task_due_date)}</span>
                  </div>
                  <p class="text-sm mb-2" style="color: var(--text-secondary);">${task.task_description}</p>
                  <div class="flex items-center gap-2">
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24" style="color: var(--text-secondary);">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 011-1h2a1 1 0 011 1v5m-4 0h4"/>
                    </svg>
                    <span class="text-sm" style="color: var(--text-secondary);">${task.className}</span>
                  </div>
                </div>
              `).join('')}
            </div>
          `}
        </div>
      `;
      
      openModal(html);
    }

    function navigateToClassTask(classId) {
      closeModal();
      navigateToClass(classId);
      switchClassTab('info');
    }

    function openMessagesPopup() {
      const userClasses = allData.filter(d => 
        d.type === 'class_member' && 
        d.user_id === currentUser.id
      );
      
      let classesWithMessages = [];
      userClasses.forEach(membership => {
        const classData = allData.find(d => d.type === 'class' && d.id === membership.class_id);
        const classMessages = allData.filter(d => 
          d.type === 'message' && 
          d.class_id === membership.class_id
        ).sort((a, b) => new Date(b.created_at) - new Date(a.created_at));
        
        if (classMessages.length > 0) {
          const lastMessage = classMessages[0];
          classesWithMessages.push({
            classId: membership.class_id,
            className: classData ? classData.class_name : 'Kelas Tidak Diketahui',
            lastMessage: lastMessage.message,
            lastSender: lastMessage.sender_name,
            lastTime: lastMessage.created_at,
            unreadCount: classMessages.filter(m => m.sender_id !== currentUser.id).length
          });
        }
      });
      
      classesWithMessages.sort((a, b) => new Date(b.lastTime) - new Date(a.lastTime));
      
      const html = `
        <div class="p-6">
          <div class="flex items-center justify-between mb-6">
            <h3 class="text-xl font-bold">Pesan</h3>
            <button onclick="closeModal()" class="p-2 rounded-lg hover:bg-opacity-10" style="background: var(--hover-bg);">
              <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
              </svg>
            </button>
          </div>
          
          ${classesWithMessages.length === 0 ? `
            <div class="p-8 text-center" style="color: var(--text-secondary);">
              <svg class="w-12 h-12 mx-auto mb-3 opacity-50" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z"/>
              </svg>
              <p>Tidak ada pesan</p>
            </div>
          ` : `
            <div class="space-y-3">
              ${classesWithMessages.map(item => `
                <div onclick="navigateToClassChat('${item.classId}')" class="p-4 rounded-xl cursor-pointer hover:bg-opacity-50 transition-all border" style="background: var(--hover-bg); border-color: var(--border-color);">
                  <div class="flex items-start justify-between mb-2">
                    <h4 class="font-semibold">${item.className}</h4>
                    ${item.unreadCount > 0 ? `<span class="bg-rose-500 text-white text-xs px-2 py-0.5 rounded-full">${item.unreadCount}</span>` : ''}
                  </div>
                  <p class="text-sm mb-1" style="color: var(--text-secondary);"><strong>${item.lastSender}:</strong> ${item.lastMessage}</p>
                  <p class="text-xs" style="color: var(--text-secondary);">${formatDate(item.lastTime)}</p>
                </div>
              `).join('')}
            </div>
          `}
        </div>
      `;
      
      openModal(html);
    }

    function navigateToClassChat(classId) {
      closeModal();
      navigateToClass(classId);
      switchClassTab('chat');
    }

    // ==================== CREATE CLASS ====================
    function openCreateClassModal() {
      const html = `
        <div class="p-6">
          <div class="flex items-center justify-between mb-6">
            <h3 class="text-xl font-bold">Buat Kelas Baru</h3>
            <button onclick="closeModal()" class="p-2 rounded-lg hover:bg-opacity-10" style="background: var(--hover-bg);">
              <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
              </svg>
            </button>
          </div>
          <form id="create-class-form" onsubmit="handleCreateClass(event)">
            <div class="space-y-4">
              <div>
                <label for="class-name" class="block text-sm font-medium mb-2" style="color: var(--text-secondary);">Nama Kelas</label>
                <input type="text" id="class-name" required placeholder="Contoh: Kelas 12 IPA 1" class="w-full px-4 py-3 rounded-xl border focus:ring-2 focus:ring-sky-500" style="background: var(--bg-secondary); border-color: var(--border-color); color: var(--text-primary);">
              </div>
              <div>
                <label for="class-description" class="block text-sm font-medium mb-2" style="color: var(--text-secondary);">Deskripsi (Opsional)</label>
                <textarea id="class-description" rows="3" placeholder="Deskripsi kelas..." class="w-full px-4 py-3 rounded-xl border focus:ring-2 focus:ring-sky-500" style="background: var(--bg-secondary); border-color: var(--border-color); color: var(--text-primary);"></textarea>
              </div>
              <div>
                <label class="block text-sm font-medium mb-2" style="color: var(--text-secondary);">Anda akan menjadi Ketua Kelas</label>
                <div class="p-3 rounded-xl border bg-sky-50" style="border-color: var(--border-color);">
                  <p class="text-sm text-sky-700">Sebagai pembuat kelas, Anda otomatis menjadi Ketua Kelas dan dapat mengelola semua aspek kelas.</p>
                </div>
              </div>
            </div>
            <button type="submit" class="w-full gradient-primary text-white py-3 rounded-xl font-semibold mt-6 hover:shadow-lg transition-all">
              Buat Kelas
            </button>
          </form>
        </div>
      `;
      
      openModal(html);
    }

    async function handleCreateClass(e) {
      e.preventDefault();
      
      if (allData.length >= 995) {
        showToast('Batas maksimum data tercapai', 'error');
        return;
      }
      
      showLoading();
      
      const className = document.getElementById('class-name').value.trim();
      const description = document.getElementById('class-description').value.trim();
      
      const classId = generateId();
      const newClass = {
        id: classId,
        type: 'class',
        class_name: className,
        class_description: description,
        created_by: currentUser.id,
        created_at: new Date().toISOString(),
        status: 'active'
      };
      
      const membership = {
        id: generateId(),
        type: 'class_member',
        class_id: classId,
        user_id: currentUser.id,
        role: 'ketua',
        status: 'active',
        created_at: new Date().toISOString()
      };
      
      const result1 = await window.dataSdk.create(newClass);
      const result2 = await window.dataSdk.create(membership);
      
      showLoading(false);
      
      if (result1.isOk && result2.isOk) {
        showToast('Kelas berhasil dibuat! Anda adalah Ketua Kelas.', 'success');
        closeModal();
      } else {
        showToast('Gagal membuat kelas', 'error');
      }
    }

    // ==================== CLASS DATA ====================
    function updateClassData() {
      document.getElementById('class-title').textContent = currentClass.class_name;
      const roleInfo = ROLES[currentClass.userRole] || ROLES.anggota;
      document.getElementById('class-role-badge').textContent = roleInfo.label;
      
      updateClassPermissions();
      renderClassFinance();
      renderClassMembers();
      renderClassTasks();
      renderClassChat();
    }

    function updateClassPermissions() {
      const role = ROLES[currentClass.userRole];
      
      // Show/hide add task button - HANYA SEKRETARIS
      const addTaskBtn = document.getElementById('add-task-btn');
      if (role.canManageTasks) {
        addTaskBtn.classList.remove('hidden');
        addTaskBtn.innerHTML = `
          <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"/>
          </svg>
          Tambah Tugas
        `;
      } else if (role.canProposeTasks) {
        addTaskBtn.classList.remove('hidden');
        addTaskBtn.innerHTML = `
          <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"/>
          </svg>
          Usulkan Tugas
        `;
      } else {
        addTaskBtn.classList.add('hidden');
      }
      
      // Show/hide add member button - Admin and Ketua can add directly
      const addMemberBtn = document.getElementById('add-member-btn');
      if (role.canAddMember) {
        addMemberBtn.classList.remove('hidden');
      } else {
        addMemberBtn.classList.add('hidden');
      }
      
      // Show/hide finance actions - HANYA BENDAHARA
      const financeActions = document.getElementById('finance-actions');
      if (role.canManageFinance) {
        financeActions.classList.remove('hidden');
        financeActions.innerHTML = `
          <button onclick="openTransactionModal('income')" class="gradient-success text-white px-4 py-2.5 rounded-xl font-medium shadow-lg hover:shadow-xl transition-all flex items-center gap-2">
            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"/>
            </svg>
            Tambah Pemasukan
          </button>
          <button onclick="openTransactionModal('expense')" class="gradient-danger text-white px-4 py-2.5 rounded-xl font-medium shadow-lg hover:shadow-xl transition-all flex items-center gap-2">
            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20 12H4"/>
            </svg>
            Tambah Pengeluaran
          </button>
          <button onclick="openFinanceHistoryModal()" class="gradient-purple text-white px-4 py-2.5 rounded-xl font-medium shadow-lg hover:shadow-xl transition-all flex items-center gap-2">
            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"/>
            </svg>
            Riwayat
          </button>
          <button onclick="openResetFinanceModal()" class="bg-amber-500 hover:bg-amber-600 text-white px-4 py-2.5 rounded-xl font-medium shadow-lg hover:shadow-xl transition-all flex items-center gap-2">
            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"/>
            </svg>
            Reset Keuangan
          </button>
        `;
      } else if (role.canProposeFinance) {
        financeActions.classList.remove('hidden');
        financeActions.innerHTML = `
          <button onclick="openProposeTransactionModal('income')" class="gradient-success text-white px-4 py-2.5 rounded-xl font-medium shadow-lg hover:shadow-xl transition-all flex items-center gap-2">
            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"/>
            </svg>
            Usulkan Pemasukan
          </button>
          <button onclick="openProposeTransactionModal('expense')" class="gradient-danger text-white px-4 py-2.5 rounded-xl font-medium shadow-lg hover:shadow-xl transition-all flex items-center gap-2">
            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20 12H4"/>
            </svg>
            Usulkan Pengeluaran
          </button>
          <button onclick="openFinanceHistoryModal()" class="gradient-purple text-white px-4 py-2.5 rounded-xl font-medium shadow-lg hover:shadow-xl transition-all flex items-center gap-2">
            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"/>
            </svg>
            Riwayat
          </button>
        `;
      } else {
        financeActions.classList.add('hidden');
      }
    }

    async function switchClassTab(tab) {
      document.querySelectorAll('.class-tab-content').forEach(content => {
        content.classList.add('hidden');
      });
      document.getElementById(`class-tab-${tab}`).classList.remove('hidden');
      
      document.querySelectorAll('.class-tab-btn').forEach(btn => {
        if (btn.dataset.tab === tab) {
          btn.className = 'class-tab-btn px-4 py-3 font-medium border-b-2 border-sky-500 text-sky-500 whitespace-nowrap';
        } else {
          btn.className = 'class-tab-btn px-4 py-3 font-medium border-b-2 border-transparent whitespace-nowrap hover:bg-opacity-10';
          btn.style.color = 'var(--text-secondary)';
          btn.style.background = 'var(--hover-bg)';
        }
      });
      
      // Mark all messages as read when opening chat tab
      if (tab === 'chat' && currentClass) {
        const unreadMessages = allData.filter(d => 
          d.type === 'message' && 
          d.class_id === currentClass.id &&
          d.sender_id !== currentUser.id &&
          !d.is_read
        );
        
        for (const msg of unreadMessages) {
          const updatedMsg = { ...msg, is_read: true };
          await window.dataSdk.update(updatedMsg);
        }
      }
    }

    // ==================== CLASS FINANCE ====================
    function renderClassFinance() {
      const transactions = allData.filter(d => 
        (d.type === 'transaction' || d.type === 'income' || d.type === 'expense') && 
        d.class_id === currentClass.id
      );
      
      const income = transactions.filter(t => t.type === 'income' || (t.type === 'transaction' && t.category === 'income')).reduce((sum, t) => sum + t.amount, 0);
      const expense = transactions.filter(t => t.type === 'expense' || (t.type === 'transaction' && t.category === 'expense')).reduce((sum, t) => sum + t.amount, 0);
      const balance = income - expense;
      
      document.getElementById('class-balance').textContent = formatCurrency(balance);
      document.getElementById('class-income').textContent = formatCurrency(income);
      document.getElementById('class-expense').textContent = formatCurrency(expense);
      
      const container = document.getElementById('transactions-list');
      const sorted = transactions.sort((a, b) => new Date(b.created_at) - new Date(a.created_at));
      
      if (sorted.length === 0) {
        container.innerHTML = `
          <div class="p-8 text-center" style="color: var(--text-secondary);">
            <svg class="w-12 h-12 mx-auto mb-3 opacity-50" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2"/>
            </svg>
            <p>Belum ada transaksi</p>
          </div>
        `;
        return;
      }
      
      container.innerHTML = sorted.map(item => {
        const isIncome = item.type === 'income' || (item.type === 'transaction' && item.category === 'income');
        return `
          <div class="flex items-center gap-4 p-4 hover:bg-opacity-50 transition-all" style="background: var(--hover-bg);">
            <div class="w-10 h-10 ${isIncome ? 'bg-emerald-100' : 'bg-rose-100'} rounded-xl flex items-center justify-center shrink-0">
              <svg class="w-5 h-5 ${isIncome ? 'text-emerald-600' : 'text-rose-600'}" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                ${isIncome 
                  ? '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 11l5-5m0 0l5 5m-5-5v12"/>'
                  : '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 13l-5 5m0 0l-5-5m5 5V6"/>'}
              </svg>
            </div>
            <div class="flex-1 min-w-0">
              <p class="font-medium">${item.description || item.category}</p>
              <p class="text-sm" style="color: var(--text-secondary);">${formatDate(item.created_at)}</p>
            </div>
            <span class="font-bold ${isIncome ? 'text-emerald-600' : 'text-rose-600'}">
              ${isIncome ? '+' : '-'}${formatCurrency(item.amount)}
            </span>
          </div>
        `;
      }).join('');
    }

    function openTransactionModal(type) {
      const html = `
        <div class="p-6">
          <div class="flex items-center justify-between mb-6">
            <h3 class="text-xl font-bold">${type === 'income' ? 'Tambah Pemasukan' : 'Tambah Pengeluaran'}</h3>
            <button onclick="closeModal()" class="p-2 rounded-lg hover:bg-opacity-10" style="background: var(--hover-bg);">
              <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
              </svg>
            </button>
          </div>
          <form id="transaction-form" onsubmit="handleAddTransaction(event, '${type}')">
            <div class="space-y-4">
              <div>
                <label for="transaction-amount" class="block text-sm font-medium mb-2" style="color: var(--text-secondary);">Jumlah (Rp)</label>
                <input type="number" id="transaction-amount" required min="1" placeholder="50000" class="w-full px-4 py-3 rounded-xl border focus:ring-2 focus:ring-${type === 'income' ? 'emerald' : 'rose'}-500" style="background: var(--bg-secondary); border-color: var(--border-color); color: var(--text-primary);">
              </div>
              <div>
                <label for="transaction-desc" class="block text-sm font-medium mb-2" style="color: var(--text-secondary);">Keterangan</label>
                <textarea id="transaction-desc" rows="3" required placeholder="Keterangan..." class="w-full px-4 py-3 rounded-xl border focus:ring-2 focus:ring-${type === 'income' ? 'emerald' : 'rose'}-500" style="background: var(--bg-secondary); border-color: var(--border-color); color: var(--text-primary);"></textarea>
              </div>
            </div>
            <button type="submit" class="w-full gradient-${type === 'income' ? 'success' : 'danger'} text-white py-3 rounded-xl font-semibold mt-6 hover:shadow-lg transition-all">
              Simpan
            </button>
          </form>
        </div>
      `;
      
      openModal(html);
    }
    
    function openProposeTransactionModal(type) {
      const html = `
        <div class="p-6">
          <div class="flex items-center justify-between mb-6">
            <h3 class="text-xl font-bold">${type === 'income' ? 'Usulkan Pemasukan' : 'Usulkan Pengeluaran'}</h3>
            <button onclick="closeModal()" class="p-2 rounded-lg hover:bg-opacity-10" style="background: var(--hover-bg);">
              <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
              </svg>
            </button>
          </div>
          <div class="mb-4 p-3 rounded-xl border bg-amber-50" style="border-color: var(--border-color);">
            <p class="text-sm text-amber-700">Usulan Anda akan dikirim ke Bendahara untuk disetujui.</p>
          </div>
          <form id="propose-transaction-form" onsubmit="handleProposeTransaction(event, '${type}')">
            <div class="space-y-4">
              <div>
                <label for="propose-amount" class="block text-sm font-medium mb-2" style="color: var(--text-secondary);">Jumlah (Rp)</label>
                <input type="number" id="propose-amount" required min="1" placeholder="50000" class="w-full px-4 py-3 rounded-xl border focus:ring-2 focus:ring-${type === 'income' ? 'emerald' : 'rose'}-500" style="background: var(--bg-secondary); border-color: var(--border-color); color: var(--text-primary);">
              </div>
              <div>
                <label for="propose-desc" class="block text-sm font-medium mb-2" style="color: var(--text-secondary);">Keterangan</label>
                <textarea id="propose-desc" rows="3" required placeholder="Keterangan..." class="w-full px-4 py-3 rounded-xl border focus:ring-2 focus:ring-${type === 'income' ? 'emerald' : 'rose'}-500" style="background: var(--bg-secondary); border-color: var(--border-color); color: var(--text-primary);"></textarea>
              </div>
            </div>
            <button type="submit" class="w-full gradient-${type === 'income' ? 'success' : 'danger'} text-white py-3 rounded-xl font-semibold mt-6 hover:shadow-lg transition-all">
              Kirim Usulan
            </button>
          </form>
        </div>
      `;
      
      openModal(html);
    }
    
    async function handleProposeTransaction(e, type) {
      e.preventDefault();
      
      if (allData.length >= 999) {
        showToast('Batas maksimum data tercapai', 'error');
        return;
      }
      
      showLoading();
      
      const amount = parseInt(document.getElementById('propose-amount').value);
      const description = document.getElementById('propose-desc').value.trim();
      
      // Find bendahara
      const bendaharaMembership = allData.find(d => 
        d.type === 'class_member' && 
        d.class_id === currentClass.id && 
        d.role === 'bendahara'
      );
      
      if (!bendaharaMembership) {
        showLoading(false);
        showToast('Bendahara tidak ditemukan', 'error');
        return;
      }
      
      // Send notification to bendahara
      const notif = {
        id: generateId(),
        type: 'notification',
        target_id: bendaharaMembership.user_id,
        target_type: 'class',
        message: `${currentUser.full_name} mengusulkan ${type === 'income' ? 'pemasukan' : 'pengeluaran'} ${formatCurrency(amount)}: ${description}`,
        action: 'propose_transaction',
        class_id: currentClass.id,
        proposed_transaction: JSON.stringify({ type, amount, description, proposer: currentUser.id }),
        is_read: false,
        created_at: new Date().toISOString()
      };
      
      await window.dataSdk.create(notif);
      
      showLoading(false);
      showToast('Usulan berhasil dikirim ke Bendahara', 'success');
      closeModal();
    }

    async function handleAddTransaction(e, type) {
      e.preventDefault();
      
      if (allData.length >= 999) {
        showToast('Batas maksimum data tercapai', 'error');
        return;
      }
      
      showLoading();
      
      const amount = parseInt(document.getElementById('transaction-amount').value);
      const description = document.getElementById('transaction-desc').value.trim();
      
      const transaction = {
        id: generateId(),
        type: type,
        class_id: currentClass.id,
        category: type,
        amount,
        description,
        created_by: currentUser.id,
        created_at: new Date().toISOString(),
        status: 'completed'
      };
      
      const result = await window.dataSdk.create(transaction);
      showLoading(false);
      
      if (result.isOk) {
        showToast(`${type === 'income' ? 'Pemasukan' : 'Pengeluaran'} berhasil ditambahkan`, 'success');
        closeModal();
        
        // Notify class members
        const members = allData.filter(d => d.type === 'class_member' && d.class_id === currentClass.id && d.user_id !== currentUser.id);
        members.forEach(member => {
          createNotification(
            member.user_id,
            `${type === 'income' ? 'Pemasukan' : 'Pengeluaran'} baru di ${currentClass.class_name}: ${formatCurrency(amount)}`,
            'transaction',
            'class',
            currentClass.id
          );
        });
      } else {
        showToast('Gagal menambahkan transaksi', 'error');
      }
    }

    // ==================== FINANCE HISTORY ====================
    async function checkAndArchiveMonthlyFinance() {
      if (!currentClass) return;
      
      const now = new Date();
      const currentMonth = now.getMonth();
      const currentYear = now.getFullYear();
      
      // Check if we need to archive last month's data
      const transactions = allData.filter(d => 
        (d.type === 'transaction' || d.type === 'income' || d.type === 'expense') && 
        d.class_id === currentClass.id &&
        d.status !== 'archived'
      );
      
      for (const transaction of transactions) {
        const transDate = new Date(transaction.created_at);
        const transMonth = transDate.getMonth();
        const transYear = transDate.getFullYear();
        
        // If transaction is from previous month, archive it
        if (transYear < currentYear || (transYear === currentYear && transMonth < currentMonth)) {
          const monthName = new Date(transYear, transMonth).toLocaleDateString('id-ID', { month: 'long', year: 'numeric' });
          
          // Check if archive already exists for this month
          let archive = allData.find(d => 
            d.type === 'finance_archive' &&
            d.class_id === currentClass.id &&
            d.month === monthName
          );
          
          if (!archive && allData.length < 999) {
            // Create new archive
            archive = {
              id: generateId(),
              type: 'finance_archive',
              class_id: currentClass.id,
              archive_name: `Arsip ${monthName}`,
              month: monthName,
              year: transYear,
              archive_date: new Date().toISOString(),
              created_at: new Date().toISOString()
            };
            await window.dataSdk.create(archive);
          }
          
          // Mark transaction as archived
          const updatedTransaction = { ...transaction, status: 'archived', archive_name: monthName };
          await window.dataSdk.update(updatedTransaction);
        }
      }
    }
    
    function openFinanceHistoryModal() {
      const archives = allData.filter(d => 
        d.type === 'finance_archive' && 
        d.class_id === currentClass.id
      ).sort((a, b) => new Date(b.archive_date) - new Date(a.archive_date));
      
      const html = `
        <div class="p-6">
          <div class="flex items-center justify-between mb-6">
            <h3 class="text-xl font-bold">Riwayat Keuangan</h3>
            <button onclick="closeModal()" class="p-2 rounded-lg hover:bg-opacity-10" style="background: var(--hover-bg);">
              <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
              </svg>
            </button>
          </div>
          
          ${archives.length === 0 ? `
            <div class="p-8 text-center" style="color: var(--text-secondary);">
              <svg class="w-12 h-12 mx-auto mb-3 opacity-50" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"/>
              </svg>
              <p>Belum ada riwayat keuangan</p>
            </div>
          ` : `
            <div class="space-y-3">
              ${archives.map(archive => {
                const archivedTransactions = allData.filter(d => 
                  (d.type === 'transaction' || d.type === 'income' || d.type === 'expense') &&
                  d.class_id === currentClass.id &&
                  d.status === 'archived' &&
                  d.archive_name === archive.month
                );
                
                const income = archivedTransactions.filter(t => t.type === 'income' || (t.type === 'transaction' && t.category === 'income')).reduce((sum, t) => sum + t.amount, 0);
                const expense = archivedTransactions.filter(t => t.type === 'expense' || (t.type === 'transaction' && t.category === 'expense')).reduce((sum, t) => sum + t.amount, 0);
                const balance = income - expense;
                
                return `
                  <div class="card-hover rounded-xl p-4 border cursor-pointer" style="background: var(--bg-secondary); border-color: var(--border-color);" onclick="openArchiveDetail('${archive.month}')">
                    <div class="flex items-start justify-between mb-3">
                      <div class="flex items-center gap-3">
                        <div class="w-10 h-10 gradient-purple rounded-xl flex items-center justify-center shadow-lg">
                          <svg class="w-5 h-5 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 8h14M5 8a2 2 0 110-4h14a2 2 0 110 4M5 8v10a2 2 0 002 2h10a2 2 0 002-2V8m-9 4h4"/>
                          </svg>
                        </div>
                        <div>
                          <h4 class="font-bold">${archive.archive_name}</h4>
                          <p class="text-sm" style="color: var(--text-secondary);">${archivedTransactions.length} transaksi</p>
                        </div>
                      </div>
                      <button onclick="event.stopPropagation(); confirmDeleteArchive('${archive.month}')" class="p-2 rounded-lg hover:bg-rose-100 text-rose-600 transition-all">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"/>
                        </svg>
                      </button>
                    </div>
                    <div class="grid grid-cols-3 gap-2 text-sm">
                      <div>
                        <p style="color: var(--text-secondary);">Saldo</p>
                        <p class="font-bold">${formatCurrency(balance)}</p>
                      </div>
                      <div>
                        <p style="color: var(--text-secondary);">Masuk</p>
                        <p class="font-bold text-emerald-600">${formatCurrency(income)}</p>
                      </div>
                      <div>
                        <p style="color: var(--text-secondary);">Keluar</p>
                        <p class="font-bold text-rose-600">${formatCurrency(expense)}</p>
                      </div>
                    </div>
                  </div>
                `;
              }).join('')}
            </div>
          `}
        </div>
      `;
      
      openModal(html);
    }
    
    function openArchiveDetail(monthName) {
      const archivedTransactions = allData.filter(d => 
        (d.type === 'transaction' || d.type === 'income' || d.type === 'expense') &&
        d.class_id === currentClass.id &&
        d.status === 'archived' &&
        d.archive_name === monthName
      ).sort((a, b) => new Date(b.created_at) - new Date(a.created_at));
      
      const income = archivedTransactions.filter(t => t.type === 'income' || (t.type === 'transaction' && t.category === 'income')).reduce((sum, t) => sum + t.amount, 0);
      const expense = archivedTransactions.filter(t => t.type === 'expense' || (t.type === 'transaction' && t.category === 'expense')).reduce((sum, t) => sum + t.amount, 0);
      const balance = income - expense;
      
      const html = `
        <div class="p-6">
          <div class="flex items-center justify-between mb-6">
            <div>
              <h3 class="text-xl font-bold">Detail Arsip ${monthName}</h3>
              <p style="color: var(--text-secondary);">${archivedTransactions.length} transaksi</p>
            </div>
            <button onclick="openFinanceHistoryModal()" class="p-2 rounded-lg hover:bg-opacity-10" style="background: var(--hover-bg);">
              <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
              </svg>
            </button>
          </div>
          
          <div class="grid grid-cols-3 gap-4 mb-6">
            <div class="p-4 rounded-xl border" style="background: var(--bg-secondary); border-color: var(--border-color);">
              <p class="text-sm mb-1" style="color: var(--text-secondary);">Saldo</p>
              <p class="font-bold text-lg">${formatCurrency(balance)}</p>
            </div>
            <div class="p-4 rounded-xl border" style="background: var(--bg-secondary); border-color: var(--border-color);">
              <p class="text-sm mb-1" style="color: var(--text-secondary);">Pemasukan</p>
              <p class="font-bold text-lg text-emerald-600">${formatCurrency(income)}</p>
            </div>
            <div class="p-4 rounded-xl border" style="background: var(--bg-secondary); border-color: var(--border-color);">
              <p class="text-sm mb-1" style="color: var(--text-secondary);">Pengeluaran</p>
              <p class="font-bold text-lg text-rose-600">${formatCurrency(expense)}</p>
            </div>
          </div>
          
          <div class="max-h-96 overflow-auto scrollbar-thin">
            ${archivedTransactions.map(item => {
              const isIncome = item.type === 'income' || (item.type === 'transaction' && item.category === 'income');
              return `
                <div class="flex items-center gap-4 p-4 rounded-xl mb-2" style="background: var(--bg-secondary);">
                  <div class="w-10 h-10 ${isIncome ? 'bg-emerald-100' : 'bg-rose-100'} rounded-xl flex items-center justify-center shrink-0">
                    <svg class="w-5 h-5 ${isIncome ? 'text-emerald-600' : 'text-rose-600'}" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      ${isIncome 
                        ? '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 11l5-5m0 0l5 5m-5-5v12"/>'
                        : '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 13l-5 5m0 0l-5-5m5 5V6"/>'}
                    </svg>
                  </div>
                  <div class="flex-1 min-w-0">
                    <p class="font-medium">${item.description || item.category}</p>
                    <p class="text-sm" style="color: var(--text-secondary);">${formatDate(item.created_at)}</p>
                  </div>
                  <span class="font-bold ${isIncome ? 'text-emerald-600' : 'text-rose-600'}">
                    ${isIncome ? '+' : '-'}${formatCurrency(item.amount)}
                  </span>
                </div>
              `;
            }).join('')}
          </div>
        </div>
      `;
      
      openModal(html);
    }
    
    async function confirmDeleteArchive(monthName) {
      const html = `
        <div class="p-6">
          <div class="flex items-center justify-between mb-6">
            <h3 class="text-xl font-bold text-rose-600">Hapus Arsip?</h3>
            <button onclick="closeModal()" class="p-2 rounded-lg hover:bg-opacity-10" style="background: var(--hover-bg);">
              <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
              </svg>
            </button>
          </div>
          
          <p class="mb-6" style="color: var(--text-secondary);">
            Apakah Anda yakin ingin menghapus arsip <strong>${monthName}</strong>? 
            Semua data transaksi dalam arsip ini akan dihapus secara permanen dan tidak dapat dikembalikan.
          </p>
          
          <div class="flex gap-3">
            <button onclick="openFinanceHistoryModal()" class="flex-1 px-4 py-3 border rounded-xl font-medium hover:bg-opacity-10 transition-all" style="border-color: var(--border-color);">
              Batal
            </button>
            <button onclick="handleDeleteArchive('${monthName}')" class="flex-1 gradient-danger text-white px-4 py-3 rounded-xl font-medium hover:shadow-lg transition-all">
              Hapus Arsip
            </button>
          </div>
        </div>
      `;
      
      openModal(html);
    }
    
    async function handleDeleteArchive(monthName) {
      showLoading();
      
      // Delete all transactions in this archive
      const archivedTransactions = allData.filter(d => 
        (d.type === 'transaction' || d.type === 'income' || d.type === 'expense') &&
        d.class_id === currentClass.id &&
        d.status === 'archived' &&
        d.archive_name === monthName
      );
      
      for (const transaction of archivedTransactions) {
        await window.dataSdk.delete(transaction);
      }
      
      // Delete the archive itself
      const archive = allData.find(d => 
        d.type === 'finance_archive' &&
        d.class_id === currentClass.id &&
        d.month === monthName
      );
      
      if (archive) {
        await window.dataSdk.delete(archive);
      }
      
      showLoading(false);
      showToast('Arsip berhasil dihapus', 'success');
      openFinanceHistoryModal();
    }
    
    function openResetFinanceModal() {
      const transactions = allData.filter(d => 
        (d.type === 'transaction' || d.type === 'income' || d.type === 'expense') && 
        d.class_id === currentClass.id &&
        d.status !== 'archived'
      );
      
      if (transactions.length === 0) {
        showToast('Tidak ada transaksi yang perlu direset', 'info');
        return;
      }
      
      const income = transactions.filter(t => t.type === 'income' || (t.type === 'transaction' && t.category === 'income')).reduce((sum, t) => sum + t.amount, 0);
      const expense = transactions.filter(t => t.type === 'expense' || (t.type === 'transaction' && t.category === 'expense')).reduce((sum, t) => sum + t.amount, 0);
      const balance = income - expense;
      
      const html = `
        <div class="p-6">
          <div class="flex items-center justify-between mb-6">
            <h3 class="text-xl font-bold">Reset Keuangan</h3>
            <button onclick="closeModal()" class="p-2 rounded-lg hover:bg-opacity-10" style="background: var(--hover-bg);">
              <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
              </svg>
            </button>
          </div>
          
          <div class="mb-6 p-4 rounded-xl border" style="background: var(--bg-secondary); border-color: var(--border-color);">
            <p class="mb-3" style="color: var(--text-secondary);">
              Data keuangan saat ini akan dipindahkan ke riwayat dan sistem akan direset ke 0.
            </p>
            <div class="grid grid-cols-3 gap-3 text-sm">
              <div>
                <p style="color: var(--text-secondary);">Saldo</p>
                <p class="font-bold">${formatCurrency(balance)}</p>
              </div>
              <div>
                <p style="color: var(--text-secondary);">Masuk</p>
                <p class="font-bold text-emerald-600">${formatCurrency(income)}</p>
              </div>
              <div>
                <p style="color: var(--text-secondary);">Keluar</p>
                <p class="font-bold text-rose-600">${formatCurrency(expense)}</p>
              </div>
            </div>
          </div>
          
          <div>
            <label for="reset-archive-name" class="block text-sm font-medium mb-2" style="color: var(--text-secondary);">Nama Arsip</label>
            <input type="text" id="reset-archive-name" value="Reset ${new Date().toLocaleDateString('id-ID', { month: 'long', year: 'numeric' })}" class="w-full px-4 py-3 rounded-xl border focus:ring-2 focus:ring-amber-500 mb-4" style="background: var(--bg-primary); border-color: var(--border-color); color: var(--text-primary);">
          </div>
          
          <div class="flex gap-3">
            <button onclick="closeModal()" class="flex-1 px-4 py-3 border rounded-xl font-medium hover:bg-opacity-10 transition-all" style="border-color: var(--border-color);">
              Batal
            </button>
            <button onclick="handleResetFinance()" class="flex-1 bg-amber-500 hover:bg-amber-600 text-white px-4 py-3 rounded-xl font-medium hover:shadow-lg transition-all">
              Reset Sekarang
            </button>
          </div>
        </div>
      `;
      
      openModal(html);
    }
    
    async function handleResetFinance() {
      if (allData.length >= 999) {
        showToast('Batas maksimum data tercapai', 'error');
        return;
      }
      
      showLoading();
      
      const archiveName = document.getElementById('reset-archive-name').value.trim();
      const now = new Date();
      
      // Get all current transactions
      const transactions = allData.filter(d => 
        (d.type === 'transaction' || d.type === 'income' || d.type === 'expense') && 
        d.class_id === currentClass.id &&
        d.status !== 'archived'
      );
      
      // Create archive
      const archive = {
        id: generateId(),
        type: 'finance_archive',
        class_id: currentClass.id,
        archive_name: archiveName,
        month: archiveName,
        year: now.getFullYear(),
        archive_date: now.toISOString(),
        created_at: now.toISOString()
      };
      
      await window.dataSdk.create(archive);
      
      // Mark all transactions as archived
      for (const transaction of transactions) {
        const updatedTransaction = { ...transaction, status: 'archived', archive_name: archiveName };
        await window.dataSdk.update(updatedTransaction);
      }
      
      showLoading(false);
      showToast('Keuangan berhasil direset!', 'success');
      closeModal();
      renderClassFinance();
    }

    // ==================== CLASS MEMBERS ====================
    function renderClassMembers() {
      const members = allData.filter(d => d.type === 'class_member' && d.class_id === currentClass.id);
      const container = document.getElementById('class-members-list');
      
      if (members.length === 0) {
        container.innerHTML = `
          <div class="col-span-full rounded-2xl border p-8 text-center" style="color: var(--text-secondary); background: var(--bg-primary); border-color: var(--border-color);">
            <svg class="w-12 h-12 mx-auto mb-3 opacity-50" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4.354a4 4 0 110 5.292M15 21H3v-1a6 6 0 0112 0v1zm0 0h6v-1a6 6 0 00-9-5.197M13 7a4 4 0 11-8 0 4 4 0 018 0z"/>
            </svg>
            <p>Belum ada anggota</p>
          </div>
        `;
        return;
      }
      
      container.innerHTML = members.map(member => {
        const userData = allData.find(d => d.type === 'user' && d.id === member.user_id);
        if (!userData) return '';
        
        const roleInfo = ROLES[member.role] || ROLES.anggota;
        const initials = getInitials(userData.full_name);
        
        return `
          <div class="card-hover rounded-2xl p-6 shadow-sm border" style="background: var(--bg-primary); border-color: var(--border-color);">
            <div class="flex items-start justify-between mb-4">
              <div class="flex items-center gap-3">
                <div class="w-12 h-12 bg-gradient-to-br from-sky-400 to-sky-600 rounded-full flex items-center justify-center text-white font-bold shadow-lg">
                  ${initials}
                </div>
                <div>
                  <h4 class="font-bold">${userData.full_name}</h4>
                  <p class="text-sm" style="color: var(--text-secondary);">@${userData.username}</p>
                </div>
              </div>
              <span class="text-xs px-2 py-1 rounded-full bg-sky-100 text-sky-600">${roleInfo.label}</span>
            </div>
            ${userData.email ? `
              <div class="text-sm" style="color: var(--text-secondary);">
                <p>ðŸ“§ ${userData.email}</p>
              </div>
            ` : ''}
          </div>
        `;
      }).join('');
    }

    function openAddMemberModal() {
      const role = ROLES[currentClass.userRole];
      const allUsers = allData.filter(d => d.type === 'user');
      const currentMembers = allData.filter(d => d.type === 'class_member' && d.class_id === currentClass.id);
      const memberIds = currentMembers.map(m => m.user_id);
      const availableUsers = allUsers.filter(u => !memberIds.includes(u.id));
      
      // Check if user can only recommend (not directly add)
      const canOnlyRecommend = role.canRecommendMember && !role.canAddMember;
      
      const html = `
        <div class="p-6">
          <div class="flex items-center justify-between mb-6">
            <h3 class="text-xl font-bold">${canOnlyRecommend ? 'Sarankan Anggota' : 'Tambah Anggota'}</h3>
            <button onclick="closeModal()" class="p-2 rounded-lg hover:bg-opacity-10" style="background: var(--hover-bg);">
              <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
              </svg>
            </button>
          </div>
          
          ${canOnlyRecommend ? `
            <div class="mb-4 p-3 rounded-xl border bg-amber-50" style="border-color: var(--border-color);">
              <p class="text-sm text-amber-700">Sebagai ${role.label}, Anda dapat menyarankan anggota baru. Admin/Ketua akan menerima notifikasi untuk menyetujui.</p>
            </div>
          ` : ''}
          
          ${availableUsers.length === 0 ? `
            <div class="p-8 text-center" style="color: var(--text-secondary);">
              <p>Semua pengguna sudah menjadi anggota kelas ini</p>
            </div>
          ` : `
            <form id="add-member-form" onsubmit="handleAddMember(event, ${canOnlyRecommend})">
              <div class="space-y-4">
                <div>
                  <label for="member-search" class="block text-sm font-medium mb-2" style="color: var(--text-secondary);">Cari Pengguna</label>
                  <input type="text" id="member-search" onkeyup="filterMemberSearch()" placeholder="Cari berdasarkan nama atau username..." class="w-full px-4 py-3 rounded-xl border focus:ring-2 focus:ring-sky-500 mb-3" style="background: var(--bg-secondary); border-color: var(--border-color); color: var(--text-primary);">
                  
                  <div id="member-search-results" class="max-h-64 overflow-auto scrollbar-thin space-y-2">
                    ${availableUsers.map(u => `
                      <label class="member-search-item flex items-center gap-3 p-3 rounded-xl cursor-pointer hover:bg-opacity-50 transition-all border" style="background: var(--hover-bg); border-color: var(--border-color);" data-username="${u.username.toLowerCase()}" data-fullname="${u.full_name.toLowerCase()}">
                        <input type="radio" name="member-user" value="${u.id}" required class="w-4 h-4 text-sky-600">
                        <div class="w-10 h-10 bg-gradient-to-br from-sky-400 to-sky-600 rounded-full flex items-center justify-center text-white font-bold text-sm">
                          ${getInitials(u.full_name)}
                        </div>
                        <div class="flex-1">
                          <p class="font-semibold">${u.full_name}</p>
                          <p class="text-sm" style="color: var(--text-secondary);">@${u.username}</p>
                        </div>
                      </label>
                    `).join('')}
                  </div>
                </div>
                ${!canOnlyRecommend ? `
                  <div>
                    <label for="member-role" class="block text-sm font-medium mb-2" style="color: var(--text-secondary);">Role</label>
                    <select id="member-role" required class="w-full px-4 py-3 rounded-xl border focus:ring-2 focus:ring-sky-500" style="background: var(--bg-secondary); border-color: var(--border-color); color: var(--text-primary);">
                      <option value="">Pilih role</option>
                      <option value="ketua">Ketua Kelas</option>
                      <option value="wakil_ketua">Wakil Ketua</option>
                      <option value="bendahara">Bendahara</option>
                      <option value="sekretaris">Sekretaris</option>
                      <option value="anggota">Anggota</option>
                    </select>
                  </div>
                ` : ''}
              </div>
              <button type="submit" class="w-full gradient-primary text-white py-3 rounded-xl font-semibold mt-6 hover:shadow-lg transition-all">
                ${canOnlyRecommend ? 'Kirim Saran' : 'Undang Anggota'}
              </button>
            </form>
          `}
        </div>
      `;
      
      openModal(html);
    }
    
    function filterMemberSearch() {
      const searchTerm = document.getElementById('member-search').value.toLowerCase();
      const items = document.querySelectorAll('.member-search-item');
      
      items.forEach(item => {
        const username = item.dataset.username;
        const fullname = item.dataset.fullname;
        
        if (username.includes(searchTerm) || fullname.includes(searchTerm)) {
          item.style.display = 'flex';
        } else {
          item.style.display = 'none';
        }
      });
    }

    async function handleAddMember(e, isRecommendation = false) {
      e.preventDefault();
      
      if (allData.length >= 999) {
        showToast('Batas maksimum data tercapai', 'error');
        return;
      }
      
      showLoading();
      
      const selectedRadio = document.querySelector('input[name="member-user"]:checked');
      if (!selectedRadio) {
        showLoading(false);
        showToast('Pilih pengguna terlebih dahulu', 'error');
        return;
      }
      
      const userId = selectedRadio.value;
      const roleSelect = document.getElementById('member-role');
      const role = isRecommendation ? 'anggota' : roleSelect.value;
      
      if (isRecommendation) {
        // Send recommendation notification to Admin/Ketua
        const adminOrKetua = allData.find(d => 
          d.type === 'class_member' && 
          d.class_id === currentClass.id && 
          (d.role === 'admin' || d.role === 'ketua')
        );
        
        const recommendedUser = allData.find(d => d.type === 'user' && d.id === userId);
        
        if (adminOrKetua && recommendedUser) {
          await createNotification(
            adminOrKetua.user_id,
            `${currentUser.full_name} (${ROLES[currentClass.userRole].label}) menyarankan ${recommendedUser.full_name} untuk bergabung ke ${currentClass.class_name}`,
            'recommend',
            'class',
            currentClass.id
          );
        }
        
        showLoading(false);
        showToast('Saran anggota berhasil dikirim', 'success');
        closeModal();
      } else {
        // Create notification with assigned role
        const notif = {
          id: generateId(),
          type: 'notification',
          target_id: userId,
          target_type: 'class',
          message: `Anda diundang bergabung ke kelas ${currentClass.class_name} sebagai ${ROLES[role].label}`,
          action: 'invite',
          class_id: currentClass.id,
          assigned_role: role,
          is_read: false,
          created_at: new Date().toISOString()
        };
        
        await window.dataSdk.create(notif);
        
        showLoading(false);
        showToast('Undangan berhasil dikirim', 'success');
        closeModal();
      }
    }

    function openClassInviteModal(notif) {
      const classData = allData.find(d => d.type === 'class' && d.id === notif.class_id);
      if (!classData) {
        showToast('Kelas tidak ditemukan', 'error');
        return;
      }
      
      const html = `
        <div class="p-6">
          <div class="flex items-center justify-between mb-6">
            <h3 class="text-xl font-bold">Undangan Kelas</h3>
            <button onclick="closeModal()" class="p-2 rounded-lg hover:bg-opacity-10" style="background: var(--hover-bg);">
              <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
              </svg>
            </button>
          </div>
          
          <div class="mb-6">
            <p class="mb-4">${notif.message}</p>
            <div class="p-4 rounded-xl border" style="background: var(--bg-secondary); border-color: var(--border-color);">
              <h4 class="font-bold mb-1">${classData.class_name}</h4>
              <p class="text-sm" style="color: var(--text-secondary);">${classData.class_description || 'Tidak ada deskripsi'}</p>
            </div>
          </div>
          
          <div class="flex gap-3">
            <button onclick="handleDeclineInvite('${notif.__backendId}')" class="flex-1 px-4 py-3 border rounded-xl font-medium hover:bg-opacity-10 transition-all" style="border-color: var(--border-color); color: var(--text-primary);">
              Tolak
            </button>
            <button onclick="handleAcceptInvite('${notif.__backendId}', '${notif.class_id}')" class="flex-1 gradient-primary text-white px-4 py-3 rounded-xl font-medium hover:shadow-lg transition-all">
              Terima
            </button>
          </div>
        </div>
      `;
      
      openModal(html);
    }

    async function handleAcceptInvite(notifId, classId) {
      if (allData.length >= 999) {
        showToast('Batas maksimum data tercapai', 'error');
        return;
      }
      
      showLoading();
      
      // Get notification to extract the assigned role
      const notif = allData.find(d => d.__backendId === notifId);
      let assignedRole = 'anggota'; // Default
      
      if (notif && notif.assigned_role) {
        assignedRole = notif.assigned_role;
      }
      
      const membership = {
        id: generateId(),
        type: 'class_member',
        class_id: classId,
        user_id: currentUser.id,
        role: assignedRole,
        status: 'active',
        created_at: new Date().toISOString()
      };
      
      const result = await window.dataSdk.create(membership);
      
      // Delete notification
      if (notif) {
        await window.dataSdk.delete(notif);
      }
      
      showLoading(false);
      
      if (result.isOk) {
        showToast('Anda telah bergabung ke kelas', 'success');
        closeModal();
      } else {
        showToast('Gagal bergabung ke kelas', 'error');
      }
    }

    async function handleDeclineInvite(notifId) {
      showLoading();
      
      const notif = allData.find(d => d.__backendId === notifId);
      if (notif) {
        await window.dataSdk.delete(notif);
      }
      
      showLoading(false);
      showToast('Undangan ditolak', 'info');
      closeModal();
    }

    // ==================== CLASS TASKS ====================
    function renderClassTasks() {
      const tasks = allData.filter(d => d.type === 'task' && d.class_id === currentClass.id);
      const container = document.getElementById('tasks-list');
      
      if (tasks.length === 0) {
        container.innerHTML = `
          <div class="rounded-2xl border p-8 text-center" style="color: var(--text-secondary); background: var(--bg-primary); border-color: var(--border-color);">
            <svg class="w-12 h-12 mx-auto mb-3 opacity-50" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-6 9l2 2 4-4"/>
            </svg>
            <p>Belum ada tugas atau pengumuman</p>
          </div>
        `;
        return;
      }
      
      const sorted = tasks.sort((a, b) => new Date(a.task_due_date) - new Date(b.task_due_date));
      
      container.innerHTML = sorted.map(task => `
        <div class="card-hover rounded-2xl p-6 shadow-sm border" style="background: var(--bg-primary); border-color: var(--border-color);">
          <div class="flex items-start justify-between mb-3">
            <h4 class="font-bold text-lg flex-1">${task.task_title}</h4>
            <span class="text-xs px-2 py-1 rounded-full bg-amber-100 text-amber-600 whitespace-nowrap ml-2">
              ${formatDateShort(task.task_due_date)}
            </span>
          </div>
          <p class="mb-3" style="color: var(--text-secondary);">${task.task_description}</p>
          <div class="flex items-center justify-between text-sm" style="color: var(--text-secondary);">
            <span>Oleh: ${task.created_by}</span>
            <span>${formatDate(task.created_at)}</span>
          </div>
        </div>
      `).join('');
    }

    function openAddTaskModal() {
      const role = ROLES[currentClass.userRole];
      const isProposal = role.canProposeTasks && !role.canManageTasks;
      
      const html = `
        <div class="p-6">
          <div class="flex items-center justify-between mb-6">
            <h3 class="text-xl font-bold">${isProposal ? 'Usulkan Tugas/Pengumuman' : 'Tambah Tugas/Pengumuman'}</h3>
            <button onclick="closeModal()" class="p-2 rounded-lg hover:bg-opacity-10" style="background: var(--hover-bg);">
              <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
              </svg>
            </button>
          </div>
          ${isProposal ? `
            <div class="mb-4 p-3 rounded-xl border bg-amber-50" style="border-color: var(--border-color);">
              <p class="text-sm text-amber-700">Usulan Anda akan dikirim ke Sekretaris untuk disetujui.</p>
            </div>
          ` : ''}
          <form id="add-task-form" onsubmit="${isProposal ? 'handleProposeTask(event)' : 'handleAddTask(event)'}">
            <div class="space-y-4">
              <div>
                <label for="task-title" class="block text-sm font-medium mb-2" style="color: var(--text-secondary);">Judul</label>
                <input type="text" id="task-title" required placeholder="Judul tugas atau pengumuman" class="w-full px-4 py-3 rounded-xl border focus:ring-2 focus:ring-sky-500" style="background: var(--bg-secondary); border-color: var(--border-color); color: var(--text-primary);">
              </div>
              <div>
                <label for="task-desc" class="block text-sm font-medium mb-2" style="color: var(--text-secondary);">Deskripsi</label>
                <textarea id="task-desc" rows="4" required placeholder="Deskripsi lengkap..." class="w-full px-4 py-3 rounded-xl border focus:ring-2 focus:ring-sky-500" style="background: var(--bg-secondary); border-color: var(--border-color); color: var(--text-primary);"></textarea>
              </div>
              <div>
                <label for="task-due" class="block text-sm font-medium mb-2" style="color: var(--text-secondary);">Tenggat Waktu</label>
                <input type="date" id="task-due" required class="w-full px-4 py-3 rounded-xl border focus:ring-2 focus:ring-sky-500" style="background: var(--bg-secondary); border-color: var(--border-color); color: var(--text-primary);">
              </div>
            </div>
            <button type="submit" class="w-full gradient-primary text-white py-3 rounded-xl font-semibold mt-6 hover:shadow-lg transition-all">
              ${isProposal ? 'Kirim Usulan' : 'Tambahkan'}
            </button>
          </form>
        </div>
      `;
      
      openModal(html);
    }
    
    async function handleProposeTask(e) {
      e.preventDefault();
      
      if (allData.length >= 999) {
        showToast('Batas maksimum data tercapai', 'error');
        return;
      }
      
      showLoading();
      
      const title = document.getElementById('task-title').value.trim();
      const description = document.getElementById('task-desc').value.trim();
      const dueDate = document.getElementById('task-due').value;
      
      // Find sekretaris
      const sekretarisMembership = allData.find(d => 
        d.type === 'class_member' && 
        d.class_id === currentClass.id && 
        d.role === 'sekretaris'
      );
      
      if (!sekretarisMembership) {
        showLoading(false);
        showToast('Sekretaris tidak ditemukan', 'error');
        return;
      }
      
      // Send notification to sekretaris
      const notif = {
        id: generateId(),
        type: 'notification',
        target_id: sekretarisMembership.user_id,
        target_type: 'class',
        message: `${currentUser.full_name} mengusulkan tugas: ${title}`,
        action: 'propose_task',
        class_id: currentClass.id,
        proposed_task: JSON.stringify({ title, description, dueDate, proposer: currentUser.id }),
        is_read: false,
        created_at: new Date().toISOString()
      };
      
      await window.dataSdk.create(notif);
      
      showLoading(false);
      showToast('Usulan berhasil dikirim ke Sekretaris', 'success');
      closeModal();
    }

    async function handleAddTask(e) {
      e.preventDefault();
      
      if (allData.length >= 999) {
        showToast('Batas maksimum data tercapai', 'error');
        return;
      }
      
      showLoading();
      
      const title = document.getElementById('task-title').value.trim();
      const description = document.getElementById('task-desc').value.trim();
      const dueDate = document.getElementById('task-due').value;
      
      const task = {
        id: generateId(),
        type: 'task',
        class_id: currentClass.id,
        task_title: title,
        task_description: description,
        task_due_date: dueDate,
        created_by: currentUser.full_name,
        created_at: new Date().toISOString(),
        status: 'active'
      };
      
      const result = await window.dataSdk.create(task);
      showLoading(false);
      
      if (result.isOk) {
        showToast('Tugas berhasil ditambahkan', 'success');
        closeModal();
        
        // Notify class members
        const members = allData.filter(d => d.type === 'class_member' && d.class_id === currentClass.id && d.user_id !== currentUser.id);
        members.forEach(member => {
          createNotification(
            member.user_id,
            `Tugas baru di ${currentClass.class_name}: ${title}`,
            'task',
            'class',
            currentClass.id
          );
        });
      } else {
        showToast('Gagal menambahkan tugas', 'error');
      }
    }

    // ==================== CLASS CHAT ====================
    function renderClassChat() {
      const messages = allData.filter(d => d.type === 'message' && d.class_id === currentClass.id && !d.is_deleted);
      const container = document.getElementById('chat-messages');
      
      if (messages.length === 0) {
        container.innerHTML = `
          <div class="text-center py-8" style="color: var(--text-secondary);">
            <svg class="w-12 h-12 mx-auto mb-3 opacity-50" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z"/>
            </svg>
            <p>Belum ada pesan</p>
          </div>
        `;
        return;
      }
      
      const sorted = messages.sort((a, b) => new Date(a.created_at) - new Date(b.created_at));
      
      container.innerHTML = sorted.map(msg => {
        const isOwnMessage = msg.sender_id === currentUser.id;
        const reactions = msg.reactions ? JSON.parse(msg.reactions) : {};
        const reactionEntries = Object.entries(reactions);
        
        let replyHTML = '';
        if (msg.reply_to_id) {
          replyHTML = `
            <div class="mb-2 p-2 rounded-lg border-l-2 border-sky-500 text-xs" style="background: var(--bg-tertiary); opacity: 0.8;">
              <p class="font-medium">${msg.reply_to_sender || 'Unknown'}</p>
              <p class="truncate">${msg.reply_to_message || 'Pesan tidak tersedia'}</p>
            </div>
          `;
        }
        
        return `
          <div class="flex ${isOwnMessage ? 'justify-end' : 'justify-start'} group" data-msg-id="${msg.__backendId}">
            <div class="max-w-[70%]">
              ${!isOwnMessage ? `<p class="text-xs mb-1" style="color: var(--text-secondary);">${msg.sender_name}</p>` : ''}
              ${replyHTML}
              <div class="relative">
                <div class="px-4 py-2 rounded-xl ${isOwnMessage ? 'gradient-primary text-white' : ''}" style="${!isOwnMessage ? `background: var(--hover-bg); color: var(--text-primary);` : ''}">
                  <p>${msg.is_edited ? `<span class="text-xs opacity-70">(diedit)</span> ` : ''}${msg.message}</p>
                </div>
                
                ${reactionEntries.length > 0 ? `
                  <div class="flex flex-wrap gap-1 mt-1">
                    ${reactionEntries.map(([emoji, users]) => `
                      <button onclick="toggleReaction('${msg.__backendId}', '${emoji}')" class="text-xs px-2 py-0.5 rounded-full border ${users.includes(currentUser.id) ? 'bg-sky-100 border-sky-300' : ''}" style="background: var(--hover-bg); border-color: var(--border-color);">
                        ${emoji} ${users.length}
                      </button>
                    `).join('')}
                  </div>
                ` : ''}
                
                <!-- Action buttons -->
                <div class="absolute ${isOwnMessage ? 'left-0 -translate-x-full' : 'right-0 translate-x-full'} top-0 hidden group-hover:flex items-center gap-1 px-2">
                  ${!isOwnMessage ? `
                    <button onclick="openEmojiPicker('${msg.__backendId}')" class="p-1 rounded hover:bg-opacity-20" style="background: var(--hover-bg);" title="React">
                      ðŸ˜Š
                    </button>
                    <button onclick="setReplyTo('${msg.__backendId}', '${msg.sender_name}', '${msg.message.replace(/'/g, "&apos;")}')" class="p-1 rounded hover:bg-opacity-20" style="background: var(--hover-bg);" title="Reply">
                      <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 10h10a8 8 0 018 8v2M3 10l6 6m-6-6l6-6"/>
                      </svg>
                    </button>
                  ` : `
                    <button onclick="openEditMessageModal('${msg.__backendId}', '${msg.message.replace(/'/g, "&apos;")}')" class="p-1 rounded hover:bg-opacity-20" style="background: var(--hover-bg);" title="Edit">
                      <svg class="w-4 h-4 text-sky-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"/>
                      </svg>
                    </button>
                    <button onclick="confirmDeleteMessage('${msg.__backendId}')" class="p-1 rounded hover:bg-opacity-20" style="background: var(--hover-bg);" title="Delete">
                      <svg class="w-4 h-4 text-rose-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"/>
                      </svg>
                    </button>
                  `}
                </div>
              </div>
              <p class="text-xs mt-1 ${isOwnMessage ? 'text-right' : ''}" style="color: var(--text-secondary);">${formatDate(msg.created_at)}</p>
            </div>
          </div>
        `;
      }).join('');
      
      // Scroll to bottom
      container.scrollTop = container.scrollHeight;
    }
    
    let replyToData = null;
    
    function setReplyTo(msgId, senderName, message) {
      replyToData = { msgId, senderName, message };
      
      const chatInput = document.getElementById('chat-input');
      chatInput.placeholder = `Membalas ${senderName}...`;
      chatInput.focus();
      
      // Show reply indicator
      const form = document.getElementById('chat-form');
      let indicator = document.getElementById('reply-indicator');
      if (!indicator) {
        indicator = document.createElement('div');
        indicator.id = 'reply-indicator';
        form.insertBefore(indicator, form.firstChild);
      }
      indicator.className = 'p-2 mb-2 rounded-lg border-l-2 border-sky-500 flex items-center justify-between';
      indicator.style.background = 'var(--bg-tertiary)';
      indicator.innerHTML = `
        <div class="text-sm">
          <p class="font-medium text-sky-600">Membalas ${senderName}</p>
          <p class="truncate text-xs" style="color: var(--text-secondary);">${message}</p>
        </div>
        <button onclick="cancelReply()" type="button" class="p-1 rounded hover:bg-opacity-20">
          <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
          </svg>
        </button>
      `;
    }
    
    function cancelReply() {
      replyToData = null;
      const indicator = document.getElementById('reply-indicator');
      if (indicator) indicator.remove();
      document.getElementById('chat-input').placeholder = 'Ketik pesan...';
    }
    
    function openEmojiPicker(msgId) {
      const emojis = ['ðŸ‘', 'â¤ï¸', 'ðŸ˜‚', 'ðŸ˜®', 'ðŸ˜¢', 'ðŸ™', 'ðŸŽ‰', 'ðŸ”¥'];
      
      const html = `
        <div class="p-6">
          <h3 class="text-xl font-bold mb-4">Pilih Reaksi</h3>
          <div class="grid grid-cols-4 gap-3">
            ${emojis.map(emoji => `
              <button onclick="addReaction('${msgId}', '${emoji}')" class="text-4xl p-4 rounded-xl hover:bg-opacity-50 transition-all" style="background: var(--hover-bg);">
                ${emoji}
              </button>
            `).join('')}
          </div>
        </div>
      `;
      
      openModal(html);
    }
    
    async function addReaction(msgId, emoji) {
      const msg = allData.find(d => d.__backendId === msgId);
      if (!msg) return;
      
      const reactions = msg.reactions ? JSON.parse(msg.reactions) : {};
      
      if (!reactions[emoji]) {
        reactions[emoji] = [];
      }
      
      if (!reactions[emoji].includes(currentUser.id)) {
        reactions[emoji].push(currentUser.id);
      }
      
      const updatedMsg = {
        ...msg,
        reactions: JSON.stringify(reactions)
      };
      
      await window.dataSdk.update(updatedMsg);
      closeModal();
    }
    
    async function toggleReaction(msgId, emoji) {
      const msg = allData.find(d => d.__backendId === msgId);
      if (!msg) return;
      
      const reactions = msg.reactions ? JSON.parse(msg.reactions) : {};
      
      if (!reactions[emoji]) {
        reactions[emoji] = [];
      }
      
      const index = reactions[emoji].indexOf(currentUser.id);
      if (index > -1) {
        reactions[emoji].splice(index, 1);
        if (reactions[emoji].length === 0) {
          delete reactions[emoji];
        }
      } else {
        reactions[emoji].push(currentUser.id);
      }
      
      const updatedMsg = {
        ...msg,
        reactions: JSON.stringify(reactions)
      };
      
      await window.dataSdk.update(updatedMsg);
    }
    
    function openEditMessageModal(msgId, currentMessage) {
      const html = `
        <div class="p-6">
          <div class="flex items-center justify-between mb-6">
            <h3 class="text-xl font-bold">Edit Pesan</h3>
            <button onclick="closeModal()" class="p-2 rounded-lg hover:bg-opacity-10" style="background: var(--hover-bg);">
              <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
              </svg>
            </button>
          </div>
          <form onsubmit="handleEditMessage(event, '${msgId}')">
            <textarea id="edit-message-text" rows="4" class="w-full px-4 py-3 rounded-xl border focus:ring-2 focus:ring-sky-500 mb-4" style="background: var(--bg-secondary); border-color: var(--border-color); color: var(--text-primary);">${currentMessage}</textarea>
            <button type="submit" class="w-full gradient-primary text-white py-3 rounded-xl font-semibold hover:shadow-lg transition-all">
              Simpan Perubahan
            </button>
          </form>
        </div>
      `;
      
      openModal(html);
    }
    
    async function handleEditMessage(e, msgId) {
      e.preventDefault();
      
      const newMessage = document.getElementById('edit-message-text').value.trim();
      if (!newMessage) {
        showToast('Pesan tidak boleh kosong', 'error');
        return;
      }
      
      showLoading();
      
      const msg = allData.find(d => d.__backendId === msgId);
      if (!msg) {
        showLoading(false);
        showToast('Pesan tidak ditemukan', 'error');
        return;
      }
      
      const updatedMsg = {
        ...msg,
        message: newMessage,
        is_edited: true,
        original_message: msg.original_message || msg.message,
        updated_at: new Date().toISOString()
      };
      
      const result = await window.dataSdk.update(updatedMsg);
      showLoading(false);
      
      if (result.isOk) {
        showToast('Pesan berhasil diubah', 'success');
        closeModal();
      } else {
        showToast('Gagal mengubah pesan', 'error');
      }
    }
    
    function confirmDeleteMessage(msgId) {
      const html = `
        <div class="p-6">
          <div class="flex items-center justify-between mb-6">
            <h3 class="text-xl font-bold text-rose-600">Hapus Pesan?</h3>
            <button onclick="closeModal()" class="p-2 rounded-lg hover:bg-opacity-10" style="background: var(--hover-bg);">
              <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
              </svg>
            </button>
          </div>
          <p class="mb-6" style="color: var(--text-secondary);">
            Pesan ini akan dihapus dan ditampilkan sebagai "Pesan telah dihapus" untuk anggota lain.
          </p>
          <div class="flex gap-3">
            <button onclick="closeModal()" class="flex-1 px-4 py-3 border rounded-xl font-medium hover:bg-opacity-10 transition-all" style="border-color: var(--border-color);">
              Batal
            </button>
            <button onclick="handleDeleteMessage('${msgId}')" class="flex-1 gradient-danger text-white px-4 py-3 rounded-xl font-medium hover:shadow-lg transition-all">
              Hapus
            </button>
          </div>
        </div>
      `;
      
      openModal(html);
    }
    
    async function handleDeleteMessage(msgId) {
      showLoading();
      
      const msg = allData.find(d => d.__backendId === msgId);
      if (!msg) {
        showLoading(false);
        showToast('Pesan tidak ditemukan', 'error');
        return;
      }
      
      const updatedMsg = {
        ...msg,
        message: 'Pesan telah dihapus',
        is_deleted: true,
        deleted_at: new Date().toISOString()
      };
      
      const result = await window.dataSdk.update(updatedMsg);
      showLoading(false);
      
      if (result.isOk) {
        showToast('Pesan berhasil dihapus', 'success');
        closeModal();
      } else {
        showToast('Gagal menghapus pesan', 'error');
      }
    }

    async function handleSendMessage(e) {
      e.preventDefault();
      
      if (allData.length >= 999) {
        showToast('Batas maksimum data tercapai', 'error');
        return;
      }
      
      const input = document.getElementById('chat-input');
      const message = input.value.trim();
      
      if (!message) return;
      
      const msg = {
        id: generateId(),
        type: 'message',
        class_id: currentClass.id,
        message,
        sender_id: currentUser.id,
        sender_name: currentUser.full_name,
        is_read: false,
        is_edited: false,
        is_deleted: false,
        reactions: JSON.stringify({}),
        reply_to_id: replyToData ? replyToData.msgId : null,
        reply_to_sender: replyToData ? replyToData.senderName : null,
        reply_to_message: replyToData ? replyToData.message : null,
        created_at: new Date().toISOString()
      };
      
      const result = await window.dataSdk.create(msg);
      
      if (result.isOk) {
        input.value = '';
        cancelReply();
        
        // Notify class members
        const members = allData.filter(d => d.type === 'class_member' && d.class_id === currentClass.id && d.user_id !== currentUser.id);
        members.forEach(member => {
          createNotification(
            member.user_id,
            `Pesan baru dari ${currentUser.full_name} di ${currentClass.class_name}`,
            'message',
            'class',
            currentClass.id
          );
        });
      } else {
        showToast('Gagal mengirim pesan', 'error');
      }
    }

    // ==================== CLASS SETTINGS ====================
    function openClassSettingsModal() {
      const role = ROLES[currentClass.userRole];
      
      const html = `
        <div class="p-6">
          <div class="flex items-center justify-between mb-6">
            <h3 class="text-xl font-bold">Pengaturan Kelas</h3>
            <button onclick="closeModal()" class="p-2 rounded-lg hover:bg-opacity-10" style="background: var(--hover-bg);">
              <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
              </svg>
            </button>
          </div>
          
          <div class="space-y-3">
            ${role.canEdit ? `
              <button onclick="openEditClassModal()" class="w-full flex items-center gap-3 p-4 rounded-xl hover:bg-opacity-10 transition-all text-left" style="background: var(--hover-bg);">
                <svg class="w-5 h-5 text-sky-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"/>
                </svg>
                <span class="font-medium">Edit Nama & Deskripsi Kelas</span>
              </button>
            ` : ''}
            ${currentClass.userRole === 'ketua' ? `
              <button onclick="openTransferLeadershipModal()" class="w-full flex items-center gap-3 p-4 rounded-xl hover:bg-opacity-10 transition-all text-left" style="background: var(--hover-bg);">
                <svg class="w-5 h-5 text-purple-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7h12m0 0l-4-4m4 4l-4 4m0 6H4m0 0l4 4m-4-4l4-4"/>
                </svg>
                <span class="font-medium">Transfer Posisi Ketua Kelas</span>
              </button>
            ` : ''}
            ${role.canRecommendMember ? `
              <button onclick="openAddMemberModal()" class="w-full flex items-center gap-3 p-4 rounded-xl hover:bg-opacity-10 transition-all text-left" style="background: var(--hover-bg);">
                <svg class="w-5 h-5 text-emerald-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M18 9v3m0 0v3m0-3h3m-3 0h-3m-2-5a4 4 0 11-8 0 4 4 0 018 0zM3 20a6 6 0 0112 0v1H3v-1z"/>
                </svg>
                <span class="font-medium">${role.canAddMember ? 'Undang' : 'Sarankan'} Anggota Baru</span>
              </button>
            ` : ''}
            ${role.canDelete || currentClass.userRole === 'admin' ? `
              <button onclick="confirmDeleteClass()" class="w-full flex items-center gap-3 p-4 rounded-xl text-rose-600 hover:bg-rose-50 transition-all text-left">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"/>
                </svg>
                <span class="font-medium">Hapus Kelas</span>
              </button>
            ` : ''}
            <button onclick="requestLeaveClass()" class="w-full flex items-center gap-3 p-4 rounded-xl hover:bg-opacity-10 transition-all text-left" style="background: var(--hover-bg);">
              <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1"/>
              </svg>
              <span class="font-medium">Keluar dari Kelas</span>
            </button>
          </div>
        </div>
      `;
      
      openModal(html);
    }
    
    function openEditClassModal() {
      const html = `
        <div class="p-6">
          <div class="flex items-center justify-between mb-6">
            <h3 class="text-xl font-bold">Edit Kelas</h3>
            <button onclick="closeModal()" class="p-2 rounded-lg hover:bg-opacity-10" style="background: var(--hover-bg);">
              <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
              </svg>
            </button>
          </div>
          <form id="edit-class-form" onsubmit="handleEditClass(event)">
            <div class="space-y-4">
              <div>
                <label for="edit-class-name" class="block text-sm font-medium mb-2" style="color: var(--text-secondary);">Nama Kelas</label>
                <input type="text" id="edit-class-name" value="${currentClass.class_name}" required class="w-full px-4 py-3 rounded-xl border focus:ring-2 focus:ring-sky-500" style="background: var(--bg-secondary); border-color: var(--border-color); color: var(--text-primary);">
              </div>
              <div>
                <label for="edit-class-description" class="block text-sm font-medium mb-2" style="color: var(--text-secondary);">Deskripsi</label>
                <textarea id="edit-class-description" rows="3" class="w-full px-4 py-3 rounded-xl border focus:ring-2 focus:ring-sky-500" style="background: var(--bg-secondary); border-color: var(--border-color); color: var(--text-primary);">${currentClass.class_description || ''}</textarea>
              </div>
            </div>
            <button type="submit" class="w-full gradient-primary text-white py-3 rounded-xl font-semibold mt-6 hover:shadow-lg transition-all">
              Simpan Perubahan
            </button>
          </form>
        </div>
      `;
      
      openModal(html);
    }
    
    async function handleEditClass(e) {
      e.preventDefault();
      showLoading();
      
      const className = document.getElementById('edit-class-name').value.trim();
      const description = document.getElementById('edit-class-description').value.trim();
      
      const classData = allData.find(d => d.type === 'class' && d.id === currentClass.id);
      if (!classData) {
        showLoading(false);
        showToast('Data kelas tidak ditemukan', 'error');
        return;
      }
      
      const updatedClass = {
        ...classData,
        class_name: className,
        class_description: description,
        updated_at: new Date().toISOString()
      };
      
      const result = await window.dataSdk.update(updatedClass);
      showLoading(false);
      
      if (result.isOk) {
        currentClass.class_name = className;
        currentClass.class_description = description;
        document.getElementById('class-title').textContent = className;
        showToast('Kelas berhasil diperbarui', 'success');
        closeModal();
      } else {
        showToast('Gagal memperbarui kelas', 'error');
      }
    }
    
    function openTransferLeadershipModal() {
      const members = allData.filter(d => 
        d.type === 'class_member' && 
        d.class_id === currentClass.id && 
        d.user_id !== currentUser.id
      );
      
      if (members.length === 0) {
        showToast('Tidak ada anggota lain untuk mentransfer kepemimpinan', 'info');
        return;
      }
      
      const html = `
        <div class="p-6">
          <div class="flex items-center justify-between mb-6">
            <h3 class="text-xl font-bold">Transfer Kepemimpinan</h3>
            <button onclick="closeModal()" class="p-2 rounded-lg hover:bg-opacity-10" style="background: var(--hover-bg);">
              <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
              </svg>
            </button>
          </div>
          
          <p class="mb-4 text-sm" style="color: var(--text-secondary);">
            Pilih anggota yang akan menjadi Ketua Kelas baru. Anda akan memilih peran baru untuk diri Anda sendiri.
          </p>
          
          <form id="transfer-leadership-form" onsubmit="handleTransferLeadership(event)">
            <div class="space-y-4">
              <div>
                <label for="new-leader" class="block text-sm font-medium mb-2" style="color: var(--text-secondary);">Pilih Ketua Baru</label>
                <select id="new-leader" required class="w-full px-4 py-3 rounded-xl border focus:ring-2 focus:ring-purple-500" style="background: var(--bg-secondary); border-color: var(--border-color); color: var(--text-primary);">
                  <option value="">Pilih anggota</option>
                  ${members.map(m => {
                    const userData = allData.find(d => d.type === 'user' && d.id === m.user_id);
                    return userData ? `<option value="${m.user_id}">${userData.full_name} (@${userData.username}) - ${ROLES[m.role].label}</option>` : '';
                  }).join('')}
                </select>
              </div>
              <div>
                <label for="self-new-role" class="block text-sm font-medium mb-2" style="color: var(--text-secondary);">Peran Anda Setelah Transfer</label>
                <select id="self-new-role" required class="w-full px-4 py-3 rounded-xl border focus:ring-2 focus:ring-purple-500" style="background: var(--bg-secondary); border-color: var(--border-color); color: var(--text-primary);">
                  <option value="">Pilih peran baru Anda</option>
                  <option value="wakil_ketua">Wakil Ketua</option>
                  <option value="bendahara">Bendahara</option>
                  <option value="sekretaris">Sekretaris</option>
                  <option value="anggota">Anggota</option>
                </select>
              </div>
            </div>
            <button type="submit" class="w-full gradient-purple text-white py-3 rounded-xl font-semibold mt-6 hover:shadow-lg transition-all">
              Transfer Kepemimpinan
            </button>
          </form>
        </div>
      `;
      
      openModal(html);
    }
    
    async function handleTransferLeadership(e) {
      e.preventDefault();
      
      const newLeaderId = document.getElementById('new-leader').value;
      const selfNewRole = document.getElementById('self-new-role').value;
      
      if (!newLeaderId || !selfNewRole) {
        showToast('Pilih anggota dan peran baru Anda', 'error');
        return;
      }
      
      showLoading();
      
      // Update new leader
      const newLeaderMembership = allData.find(d => 
        d.type === 'class_member' && 
        d.class_id === currentClass.id && 
        d.user_id === newLeaderId
      );
      
      if (newLeaderMembership) {
        const updatedNewLeader = { ...newLeaderMembership, role: 'ketua' };
        await window.dataSdk.update(updatedNewLeader);
      }
      
      // Update self
      const selfMembership = allData.find(d => 
        d.type === 'class_member' && 
        d.class_id === currentClass.id && 
        d.user_id === currentUser.id
      );
      
      if (selfMembership) {
        const updatedSelf = { ...selfMembership, role: selfNewRole };
        await window.dataSdk.update(updatedSelf);
      }
      
      // Send notification
      const newLeaderUser = allData.find(d => d.type === 'user' && d.id === newLeaderId);
      if (newLeaderUser) {
        await createNotification(
          newLeaderId,
          `Anda telah ditunjuk sebagai Ketua Kelas baru di ${currentClass.class_name} oleh ${currentUser.full_name}`,
          'approve',
          'class',
          currentClass.id
        );
      }
      
      showLoading(false);
      showToast('Kepemimpinan berhasil ditransfer', 'success');
      closeModal();
      backToHome();
    }

    async function requestLeaveClass() {
      if (currentClass.userRole === 'ketua') {
        showToast('Ketua kelas harus transfer kepemimpinan terlebih dahulu', 'error');
        closeModal();
        return;
      }
      
      const html = `
        <div class="p-6">
          <div class="flex items-center justify-between mb-6">
            <h3 class="text-xl font-bold">Keluar dari Kelas</h3>
            <button onclick="closeModal()" class="p-2 rounded-lg hover:bg-opacity-10" style="background: var(--hover-bg);">
              <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
              </svg>
            </button>
          </div>
          
          <p class="mb-6" style="color: var(--text-secondary);">
            Anda akan mengajukan permintaan keluar dari kelas <strong>${currentClass.class_name}</strong>. 
            Permintaan ini memerlukan persetujuan dari Ketua Kelas.
          </p>
          
          <div class="flex gap-3">
            <button onclick="closeModal()" class="flex-1 px-4 py-3 border rounded-xl font-medium hover:bg-opacity-10 transition-all" style="border-color: var(--border-color);">
              Batal
            </button>
            <button onclick="handleRequestLeaveClass()" class="flex-1 bg-amber-500 hover:bg-amber-600 text-white px-4 py-3 rounded-xl font-medium hover:shadow-lg transition-all">
              Ajukan Permintaan
            </button>
          </div>
        </div>
      `;
      
      openModal(html);
    }
    
    async function handleRequestLeaveClass() {
      if (allData.length >= 999) {
        showToast('Batas maksimum data tercapai', 'error');
        return;
      }
      
      showLoading();
      
      // Find ketua
      const ketuaMembership = allData.find(d => 
        d.type === 'class_member' && 
        d.class_id === currentClass.id && 
        d.role === 'ketua'
      );
      
      if (!ketuaMembership) {
        showLoading(false);
        showToast('Ketua kelas tidak ditemukan', 'error');
        return;
      }
      
      // Send notification to ketua
      await createNotification(
        ketuaMembership.user_id,
        `${currentUser.full_name} (${ROLES[currentClass.userRole].label}) meminta izin keluar dari ${currentClass.class_name}`,
        'leave_request',
        'class',
        currentClass.id
      );
      
      showLoading(false);
      showToast('Permintaan keluar telah dikirim ke Ketua Kelas', 'success');
      closeModal();
    }
    
    function openLeaveRequestModal(notif) {
      // Parse user data from notification
      const matches = notif.message.match(/^(.+) \((.+)\) meminta izin keluar dari (.+)$/);
      if (!matches) return;
      
      const requesterName = matches[1];
      const requesterRole = matches[2];
      
      // Find the requester's membership
      const requesterMembership = allData.find(d => 
        d.type === 'class_member' && 
        d.class_id === notif.class_id &&
        d.user_id !== currentUser.id // Not self
      );
      
      const html = `
        <div class="p-6">
          <div class="flex items-center justify-between mb-6">
            <h3 class="text-xl font-bold">Permintaan Keluar Kelas</h3>
            <button onclick="closeModal()" class="p-2 rounded-lg hover:bg-opacity-10" style="background: var(--hover-bg);">
              <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
              </svg>
            </button>
          </div>
          
          <div class="mb-6">
            <p class="mb-4">${notif.message}</p>
            <div class="p-4 rounded-xl border bg-amber-50" style="border-color: var(--border-color);">
              <p class="text-sm text-amber-700">Sebagai Ketua Kelas, Anda perlu menyetujui atau menolak permintaan ini.</p>
            </div>
          </div>
          
          <div class="flex gap-3">
            <button onclick="handleRejectLeaveRequest('${notif.__backendId}')" class="flex-1 px-4 py-3 border rounded-xl font-medium text-rose-600 hover:bg-rose-50 transition-all">
              Tolak
            </button>
            <button onclick="handleApproveLeaveRequest('${notif.__backendId}', '${notif.class_id}', '${requesterMembership ? requesterMembership.__backendId : ''}')" class="flex-1 gradient-success text-white px-4 py-3 rounded-xl font-medium hover:shadow-lg transition-all">
              Setujui
            </button>
          </div>
        </div>
      `;
      
      openModal(html);
    }
    
    async function handleApproveLeaveRequest(notifId, classId, membershipId) {
      showLoading();
      
      // Find membership by class and remove it
      const membership = allData.find(d => 
        d.__backendId === membershipId || 
        (d.type === 'class_member' && d.class_id === classId && d.user_id !== currentUser.id)
      );
      
      if (membership) {
        await window.dataSdk.delete(membership);
        
        // Notify the requester
        await createNotification(
          membership.user_id,
          `Permintaan Anda untuk keluar dari kelas telah disetujui`,
          'approve',
          'class',
          classId
        );
      }
      
      // Delete notification
      const notif = allData.find(d => d.__backendId === notifId);
      if (notif) {
        await window.dataSdk.delete(notif);
      }
      
      showLoading(false);
      showToast('Permintaan keluar disetujui', 'success');
      closeModal();
    }
    
    async function handleRejectLeaveRequest(notifId) {
      showLoading();
      
      const notif = allData.find(d => d.__backendId === notifId);
      if (notif) {
        await window.dataSdk.delete(notif);
      }
      
      showLoading(false);
      showToast('Permintaan keluar ditolak', 'info');
      closeModal();
    }

    async function confirmDeleteClass() {
      const confirmed = confirm(`Apakah Anda yakin ingin menghapus kelas ${currentClass.class_name}? Semua data akan dihapus PERMANEN dan tidak dapat dikembalikan.`);
      
      if (!confirmed) return;
      
      showLoading();
      
      // Delete all class-related data
      const classData = allData.find(d => d.type === 'class' && d.id === currentClass.id);
      const members = allData.filter(d => d.type === 'class_member' && d.class_id === currentClass.id);
      const transactions = allData.filter(d => (d.type === 'transaction' || d.type === 'income' || d.type === 'expense') && d.class_id === currentClass.id);
      const tasks = allData.filter(d => d.type === 'task' && d.class_id === currentClass.id);
      const messages = allData.filter(d => d.type === 'message' && d.class_id === currentClass.id);
      const archives = allData.filter(d => d.type === 'finance_archive' && d.class_id === currentClass.id);
      const notifications = allData.filter(d => d.type === 'notification' && d.class_id === currentClass.id);
      
      const deletePromises = [
        classData ? window.dataSdk.delete(classData) : Promise.resolve({ isOk: true }),
        ...members.map(m => window.dataSdk.delete(m)),
        ...transactions.map(t => window.dataSdk.delete(t)),
        ...tasks.map(t => window.dataSdk.delete(t)),
        ...messages.map(m => window.dataSdk.delete(m)),
        ...archives.map(a => window.dataSdk.delete(a)),
        ...notifications.map(n => window.dataSdk.delete(n))
      ];
      
      await Promise.all(deletePromises);
      
      showLoading(false);
      showToast('Kelas berhasil dihapus PERMANEN', 'success');
      closeModal();
      backToHome();
    }

    // ==================== MODAL ====================
    function openModal(htmlContent) {
      const modal = document.getElementById('modal-container');
      const content = document.getElementById('modal-content');
      content.innerHTML = htmlContent;
      modal.classList.remove('hidden');
      
      // Prevent body scroll when modal is open
      document.body.style.overflow = 'hidden';
    }

    function closeModal() {
      document.getElementById('modal-container').classList.add('hidden');
      
      // Restore body scroll
      document.body.style.overflow = '';
    }
    
    function handleModalBackdropClick(event) {
      // Only close if clicking directly on the modal container (the backdrop)
      if (event.target.id === 'modal-container') {
        closeModal();
      }
    }

    // ==================== UI UPDATES ====================
    function updateUIColors() {
      document.getElementById('login-app-title').textContent = config.app_title || defaultConfig.app_title;
      document.getElementById('home-app-title').textContent = config.app_title || defaultConfig.app_title;
    }

    // ==================== INITIALIZATION ====================
    async function init() {
      await initElementSdk();
      await initDataSdk();
      updateUIColors();
    }

    init();
  </script>
 <script>(function(){function c(){var b=a.contentDocument||a.contentWindow.document;if(b){var d=b.createElement('script');d.innerHTML="window.__CF$cv$params={r:'9c590633b1bedf08',t:'MTc2OTY5Mjc5OC4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);";b.getElementsByTagName('head')[0].appendChild(d)}}if(document.body){var a=document.createElement('iframe');a.height=1;a.width=1;a.style.position='absolute';a.style.top=0;a.style.left=0;a.style.border='none';a.style.visibility='hidden';document.body.appendChild(a);if('loading'!==document.readyState)c();else if(window.addEventListener)document.addEventListener('DOMContentLoaded',c);else{var e=document.onreadystatechange||function(){};document.onreadystatechange=function(b){e(b);'loading'!==document.readyState&&(document.onreadystatechange=e,c())}}}})();</script></body>
</html>